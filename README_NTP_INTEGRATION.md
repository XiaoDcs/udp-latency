# æ— äººæœºUDPé€šä¿¡æµ‹è¯•ç³»ç»Ÿ - é›†æˆNTPæ—¶é—´åŒæ­¥

## ğŸ“‹ æœ€æ–°åŠŸèƒ½æ›´æ–° (v2.3) ğŸ†•

### ğŸ›£ï¸ é™æ€è·¯ç”±é…ç½®åŠŸèƒ½ ğŸ†•
- **è‡ªåŠ¨è·¯ç”±é…ç½®**: æ–°å¢ `--enable-static-route` å‚æ•°ï¼Œæ”¯æŒè‡ªåŠ¨é…ç½®é™æ€è·¯ç”±
- **ç½‘å…³è·¯ç”±æ”¯æŒ**: è‡ªåŠ¨æ‰§è¡Œ `ip route add [local-ip]/32 via [nexfi-ip]` é…ç½®æœ¬åœ°IPåˆ°ç½‘å…³çš„è·¯ç”±
- **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨æ£€æŸ¥è·¯ç”±æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤é…ç½®
- **è‡ªåŠ¨æ¸…ç†**: è„šæœ¬é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†é…ç½®çš„é™æ€è·¯ç”±ï¼Œé¿å…ç³»ç»Ÿä¸­ç•™ä¸‹æ— ç”¨è·¯ç”± ğŸ†•
- **æ•…éšœå¤„ç†**: æä¾›è¯¦ç»†çš„é”™è¯¯è¯Šæ–­å’Œç”¨æˆ·å‹å¥½çš„æ•…éšœå¤„ç†
- **ä½¿ç”¨åœºæ™¯**: é€‚ç”¨äºéœ€è¦é€šè¿‡ç‰¹å®šç½‘å…³è·¯ç”±æœ¬æœºIPçš„å¤æ‚ç½‘ç»œç¯å¢ƒ

### â±ï¸ ä¼˜åŒ–æ—¶é—´é…ç½®é€»è¾‘
- **æ˜ç¡®æ—¶é—´å‚æ•°**: `--time` å‚æ•°ç°åœ¨æ˜ç¡®è¡¨ç¤ºå®é™…UDPé€šä¿¡æ—¶é—´ï¼Œä¸åŒ…æ‹¬å‡†å¤‡æ—¶é—´
- **è‡ªåŠ¨ç¼“å†²æœºåˆ¶**: æ¥æ”¶ç«¯è‡ªåŠ¨å¢åŠ 20%ç¼“å†²æ—¶é—´ï¼ˆæœ€å°‘60ç§’ï¼‰ï¼Œç¡®ä¿å®Œæ•´æ¥æ”¶æ‰€æœ‰æ•°æ®
- **æ™ºèƒ½æ—¶é—´ç®¡ç†**: GPSå’ŒNexfiè®°å½•å™¨è‡ªåŠ¨å»¶é•¿è¿è¡Œæ—¶é—´ä»¥è¦†ç›–æ•´ä¸ªæµ‹è¯•å‘¨æœŸ
- **è¯¦ç»†æ—¶é—´æ˜¾ç¤º**: ç¨‹åºä¼šæ˜¾ç¤ºå‡†å¤‡æ—¶é—´ã€UDPé€šä¿¡æ—¶é—´ã€ç¼“å†²æ—¶é—´ç­‰è¯¦ç»†ä¿¡æ¯

### ğŸ›ï¸ çµæ´»çš„NTPé…ç½®é€‰é¡¹
- **å¯é€‰NTPå¯¹æ—¶**: æ–°å¢ `--skip-ntp` å‚æ•°ï¼Œå¯å®Œå…¨è·³è¿‡NTPæ—¶é—´åŒæ­¥åŠŸèƒ½
- **ç‹¬ç«‹NTP IP**: æ–°å¢ `--ntp-peer-ip` å‚æ•°ï¼Œæ”¯æŒNTPå¯¹æ—¶IPä¸UDPé€šä¿¡IPåˆ†ç¦»
- **é»˜è®¤è¡Œä¸º**: é»˜è®¤å¯ç”¨NTPå¯¹æ—¶ï¼Œå‘ä¸‹å…¼å®¹ç°æœ‰é…ç½®
- **ä½¿ç”¨åœºæ™¯**: é€‚åˆå·²æœ‰ç²¾ç¡®æ—¶é—´æºçš„ç¯å¢ƒæˆ–æµ‹è¯•çº¯UDPæ€§èƒ½çš„åœºæ™¯

### ğŸ”§ æ—¶é—´åŒæ­¥éªŒè¯ä¿®å¤
- **ä¿®å¤é—®é¢˜**: è§£å†³äº†chronyå¤åˆåç§»é‡æ ¼å¼è§£æé”™è¯¯ï¼Œå¦‚ `-3069ns[+1489us]` æ ¼å¼
- **æ”¹è¿›ç®—æ³•**: é‡å†™åç§»é‡è§£æé€»è¾‘ï¼Œæ”¯æŒ `ns`, `us`, `ms`, `s` ç­‰å¤šç§æ—¶é—´å•ä½
- **æå‡ç¨³å®šæ€§**: å®¢æˆ·ç«¯ç°åœ¨èƒ½æ­£ç¡®è¯†åˆ«åŒæ­¥çŠ¶æ€ï¼Œä¸å†å¡åœ¨éªŒè¯é˜¶æ®µ
- **è¯¦ç»†è¾“å‡º**: å¢åŠ æ—¶é—´åŒæ­¥è¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯æ˜¾ç¤º

### ğŸ—‘ï¸ ç§»é™¤RSSIæ¨¡æ‹Ÿå€¼
- **æ¸…ç†ä»£ç **: ç§»é™¤äº†UDPå‘é€ç«¯å’Œæ¥æ”¶ç«¯çš„æ¨¡æ‹ŸRSSIå€¼
- **ç®€åŒ–æ—¥å¿—**: æ—¥å¿—æ–‡ä»¶ä¸å†åŒ…å«æ— æ„ä¹‰çš„å›ºå®šRSSIå€¼
- **æå‡æ€§èƒ½**: å‡å°‘ä¸å¿…è¦çš„æ•°æ®å¤„ç†å’Œå­˜å‚¨

### ğŸ› ï¸ æ–°å¢é…ç½®é€‰é¡¹
- **è·³è¿‡é…ç½®**: æ–°å¢ `--skip-ntp-config` é€‰é¡¹ï¼Œå¯è·³è¿‡chronyé‡æ–°é…ç½®
- **æƒé™æ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥sudoæƒé™ï¼Œæä¾›å‹å¥½çš„ç”¨æˆ·æç¤º
- **é”™è¯¯å¤„ç†**: æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæä¾›æ›´æ¸…æ™°çš„æ•…éšœè¯Šæ–­ä¿¡æ¯

### ğŸ”‘ å…³é”®é…ç½®è¯´æ˜ - NTPå‚æ•°ä½¿ç”¨æŒ‡å—

**é‡è¦é—®é¢˜è§£ç­”**: 

**Q: `--ntp-peer-ip` å‚æ•°åº”è¯¥å¡«æœ¬æœºçš„è¿˜æ˜¯å¯¹æ–¹æœºå™¨çš„IPåœ°å€ï¼Ÿ**

**A: ä¸¤å°æœºå™¨éƒ½å¡«å†™ç›¸åŒçš„IPåœ°å€ï¼Œè¿™ä¸ªIPåœ°å€å¿…é¡»æ˜¯senderæœºå™¨ä¸Šçš„ç½‘ç»œæ¥å£IPï¼**

**æ­£ç¡®é…ç½®ç¤ºä¾‹**:
```bash
# å‡è®¾senderæœºå™¨åœ¨192.168.0.200è¿™ä¸ªæ¥å£ä¸Šå¯åŠ¨NTPæœåŠ¡å™¨

# senderæœºå™¨é…ç½®ï¼š
./start_test.sh sender --local-ip=192.168.104.112 --peer-ip=192.168.104.109 --ntp-peer-ip=192.168.0.200

# receiveræœºå™¨é…ç½®ï¼š
./start_test.sh receiver --local-ip=192.168.104.109 --peer-ip=192.168.104.112 --ntp-peer-ip=192.168.0.200
```

**å…³é”®è¦ç‚¹**:
1. âœ… **ä¸¤å°æœºå™¨å¡«å†™ç›¸åŒçš„IP**: `192.168.0.200`
2. âœ… **è¿™ä¸ªIPå¿…é¡»æ˜¯senderæœºå™¨çš„ç½‘ç»œæ¥å£IP**: senderä¼šåœ¨æ­¤IPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨
3. âœ… **receiverè¿æ¥åˆ°è¿™ä¸ªIP**: receiverä½œä¸ºå®¢æˆ·ç«¯è¿æ¥senderçš„NTPæœåŠ¡å™¨
4. âŒ **ä¸è¦è®©ä¸¤å°æœºå™¨å¡«å†™ä¸åŒçš„IP**: è¿™æ˜¯é”™è¯¯çš„é…ç½®

**NTPè§’è‰²åˆ†é…ï¼ˆå·²æ›´æ–°ï¼‰**:
- **sender å›ºå®šä½œä¸º NTP æœåŠ¡å™¨**: ä¸å†æ ¹æ®IPå¤§å°æ¯”è¾ƒ
- **receiver å›ºå®šä½œä¸º NTP å®¢æˆ·ç«¯**: è¿æ¥senderçš„NTPæœåŠ¡å™¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ (æ‹‰å–ä»“åº“åå¿…è¯»)

### 1. å…‹éš†ä»“åº“åçš„ç¬¬ä¸€æ­¥

```bash
# 1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°
git clone <repository-url>
cd udp-latency

# 2. è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬
chmod +x setup.sh
./setup.sh
```

**setup.sh ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š**
- âœ… æ£€æŸ¥ç³»ç»Ÿè¦æ±‚ (Linux + Python3)
- âœ… å®‰è£…ç³»ç»Ÿä¾èµ– (chrony, ç½‘ç»œå·¥å…·ç­‰)
- âœ… åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
- âœ… å®‰è£…Pythonä¾èµ–åŒ…
- âœ… è®¾ç½®æ–‡ä»¶æƒé™
- âœ… åˆ›å»ºå¿…è¦ç›®å½•
- âœ… éªŒè¯å®‰è£…

### 2. éƒ¨ç½²å®Œæˆåçš„æ“ä½œ

```bash
# æ¿€æ´»Pythonè™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æŸ¥çœ‹ä½¿ç”¨ç¤ºä¾‹
./example_usage.sh

# è¿è¡Œç¯å¢ƒæ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
./check_environment.sh
```

### 3. ç«‹å³å¼€å§‹æµ‹è¯•

#### åŸºæœ¬æµ‹è¯•ï¼ˆåŒ…å«NTPæ—¶é—´åŒæ­¥ï¼‰

**åœ¨ç¬¬ä¸€å°æ— äººæœºä¸Šï¼ˆå‘é€ç«¯ï¼‰ï¼š**
```bash
source venv/bin/activate
./start_test.sh sender
```

**åœ¨ç¬¬äºŒå°æ— äººæœºä¸Šï¼ˆæ¥æ”¶ç«¯ï¼‰ï¼š**
```bash
source venv/bin/activate
./start_test.sh receiver
```

#### è·³è¿‡NTPæ—¶é—´åŒæ­¥çš„çº¯UDPæµ‹è¯•

**åœ¨ç¬¬ä¸€å°æ— äººæœºä¸Šï¼ˆå‘é€ç«¯ï¼‰ï¼š**
```bash
source venv/bin/activate
./start_test.sh sender --skip-ntp
```

**åœ¨ç¬¬äºŒå°æ— äººæœºä¸Šï¼ˆæ¥æ”¶ç«¯ï¼‰ï¼š**
```bash
source venv/bin/activate
./start_test.sh receiver --skip-ntp
```

#### ä½¿ç”¨ç‹¬ç«‹çš„NTPå¯¹æ—¶IP ğŸ†•

**ä½¿ç”¨åœºæ™¯**:
- UDPé€šä¿¡ç½‘ç»œä¸ç®¡ç†ç½‘ç»œåˆ†ç¦»
- å¤šç½‘å¡ç¯å¢ƒï¼Œä¸åŒç½‘å¡æ‰¿æ‹…ä¸åŒåŠŸèƒ½
- ç½‘ç»œå®‰å…¨è¦æ±‚ï¼Œæ—¶é—´åŒæ­¥ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ

**é‡è¦è¯´æ˜**: `--ntp-peer-ip` å¿…é¡»æ˜¯senderæœºå™¨ä¸Šçš„ç½‘ç»œæ¥å£IPåœ°å€

**æ— äººæœºA - å‘é€ç«¯ï¼ˆsenderï¼‰**
```bash
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.10 \     # UDPé€šä¿¡IP
  --peer-ip=192.168.104.20 \      # UDPé€šä¿¡å¯¹æ–¹IP  
  --ntp-peer-ip=192.168.1.10      # æœ¬æœºNTPæœåŠ¡å™¨ç›‘å¬IPï¼ˆå¿…é¡»æ˜¯æœ¬æœºæ¥å£IPï¼ï¼‰
```

**æ— äººæœºB - æ¥æ”¶ç«¯ï¼ˆreceiverï¼‰**
```bash
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.20 \     # UDPé€šä¿¡IP
  --peer-ip=192.168.104.10 \      # UDPé€šä¿¡å¯¹æ–¹IP
  --ntp-peer-ip=192.168.1.10      # è¿æ¥åˆ°senderçš„NTPæœåŠ¡å™¨IPï¼ˆä¸senderç›¸åŒï¼ï¼‰
```

**âš ï¸ å¸¸è§é”™è¯¯é…ç½®**:
```bash
# âŒ é”™è¯¯ï¼šreceiverä½¿ç”¨è‡ªå·±çš„IPä½œä¸ºNTPæœåŠ¡å™¨IP
./start_test.sh receiver --ntp-peer-ip=192.168.1.20  # é”™è¯¯ï¼

# âœ… æ­£ç¡®ï¼šreceiverä½¿ç”¨senderçš„IPä½œä¸ºNTPæœåŠ¡å™¨IP  
./start_test.sh receiver --ntp-peer-ip=192.168.1.10  # æ­£ç¡®ï¼
```

### 4. å¦‚éœ€GPSè®°å½•åŠŸèƒ½

GPSè®°å½•åŠŸèƒ½éœ€è¦ROS2ç¯å¢ƒï¼Œè¯·å•ç‹¬å®‰è£…ï¼š
```bash
# å®‰è£…ROS2 (ä»¥Humbleä¸ºä¾‹)
sudo apt update
sudo apt install ros-humble-desktop

# Source ROS2ç¯å¢ƒ
source /opt/ros/humble/setup.bash

# å®‰è£…as2_python_api (æ ¹æ®æ‚¨çš„å…·ä½“ç¯å¢ƒ)
# å…·ä½“å®‰è£…æ–¹æ³•è¯·å‚è€ƒæ‚¨çš„æ— äººæœºç³»ç»Ÿæ–‡æ¡£
```

---

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ— äººæœºUDPé€šä¿¡æµ‹è¯•ç³»ç»Ÿï¼Œé›†æˆäº†è‡ªåŠ¨NTPæ—¶é—´åŒæ­¥åŠŸèƒ½å’ŒGPSæ•°æ®è®°å½•ã€‚ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨åœ¨ä¸¤å°æ— äººæœºä¹‹é—´å»ºç«‹æ—¶é—´åŒæ­¥ï¼Œç„¶åè¿›è¡ŒUDPé€šä¿¡æ€§èƒ½æµ‹è¯•ï¼ŒåŒæ—¶è®°å½•GPSä½ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å»¶è¿Ÿã€ä¸¢åŒ…ç‡ã€ä½ç½®è½¨è¿¹ç­‰æŒ‡æ ‡çš„æµ‹é‡ã€‚

## ä¸»è¦ç‰¹æ€§

- âœ… **ä¸€é”®éƒ¨ç½²**: è¿è¡Œsetup.shå³å¯å®Œæˆç¯å¢ƒé…ç½®
- âœ… **çµæ´»çš„NTPé…ç½®**: æ”¯æŒå¯ç”¨/ç¦ç”¨NTPå¯¹æ—¶ï¼Œæ”¯æŒç‹¬ç«‹NTPå¯¹æ—¶IP ğŸ†•
- âœ… **è‡ªåŠ¨æ—¶é—´åŒæ­¥**: åŸºäºIPåœ°å€è‡ªåŠ¨ç¡®å®šNTPæœåŠ¡å™¨/å®¢æˆ·ç«¯è§’è‰²
- âœ… **æ— éœ€åœ°é¢ç«™**: ä¸¤å°æ— äººæœºè‡ªä¸»å®Œæˆæ—¶é—´åŒæ­¥
- âœ… **ä¸€é”®å¯åŠ¨**: ç®€åŒ–çš„å¯åŠ¨è„šæœ¬ï¼Œè‡ªåŠ¨åŒ–æ•´ä¸ªæµ‹è¯•æµç¨‹
- âœ… **GPSæ•°æ®è®°å½•**: é›†æˆGPSä½ç½®è®°å½•ï¼Œæ”¯æŒROS2ç¯å¢ƒ
- âœ… **Nexfié€šä¿¡çŠ¶æ€è®°å½•**: å®æ—¶è®°å½•é€šä¿¡æ¨¡å—çŠ¶æ€å’Œé“¾è·¯è´¨é‡
- âœ… **é™æ€è·¯ç”±é…ç½®**: è‡ªåŠ¨é…ç½®æœ¬åœ°IPåˆ°æŒ‡å®šç½‘å…³çš„é™æ€è·¯ç”± ğŸ†•
- âœ… **å®æ—¶ç›‘æ§**: æŒç»­ç›‘æ§æ—¶é—´åŒæ­¥çŠ¶æ€å’Œç³»ç»ŸçŠ¶æ€
- âœ… **å®Œæ•´æ—¥å¿—**: è¯¦ç»†çš„æµ‹è¯•æ—¥å¿—ã€GPSè½¨è¿¹ã€é€šä¿¡çŠ¶æ€å’ŒåŒæ­¥çŠ¶æ€è®°å½•
- âœ… **æ•…éšœå¤„ç†**: è‡ªåŠ¨å¤„ç†ç½‘ç»œä¸­æ–­å’ŒåŒæ­¥å¼‚å¸¸

## ç³»ç»Ÿæ¶æ„

### æ ‡å‡†æ¨¡å¼ï¼ˆå¯ç”¨NTPå¯¹æ—¶ï¼‰
```
æ— äººæœºA (192.168.104.10)          æ— äººæœºB (192.168.104.20)
    â†“                                    â†“
è‡ªåŠ¨æˆä¸ºNTPæœåŠ¡å™¨              â†â†’    è‡ªåŠ¨æˆä¸ºNTPå®¢æˆ·ç«¯
    â†“                                    â†“
å¯åŠ¨GPSè®°å½•å™¨                  â†â†’    å¯åŠ¨GPSè®°å½•å™¨
    â†“                                    â†“
å¯åŠ¨NexfiçŠ¶æ€è®°å½•å™¨            â†â†’    å¯åŠ¨NexfiçŠ¶æ€è®°å½•å™¨
    â†“                                    â†“
è¿è¡ŒUDPå‘é€ç«¯/æ¥æ”¶ç«¯           â†â†’    è¿è¡ŒUDPæ¥æ”¶ç«¯/å‘é€ç«¯
    â†“                                    â†“
è®°å½•æµ‹è¯•æ—¥å¿—å’ŒGPSè½¨è¿¹          â†â†’    è®°å½•æµ‹è¯•æ—¥å¿—å’ŒGPSè½¨è¿¹
```

### åˆ†ç¦»æ¨¡å¼ï¼ˆNTPå¯¹æ—¶IPä¸é€šä¿¡IPä¸åŒï¼‰ğŸ†•
```
æ— äººæœºA                               æ— äººæœºB
â”œâ”€ UDPé€šä¿¡: 192.168.104.10      â†â†’    â”œâ”€ UDPé€šä¿¡: 192.168.104.20
â””â”€ NTPå¯¹æ—¶: 192.168.1.10        â†â†’    â””â”€ NTPå¯¹æ—¶: 192.168.1.20
```

### çº¯UDPæ¨¡å¼ï¼ˆè·³è¿‡NTPå¯¹æ—¶ï¼‰ğŸ†•
```
æ— äººæœºA (192.168.104.10)          æ— äººæœºB (192.168.104.20)
    â†“                                    â†“
è·³è¿‡NTPæ—¶é—´åŒæ­¥                â†â†’    è·³è¿‡NTPæ—¶é—´åŒæ­¥
    â†“                                    â†“
ç›´æ¥å¯åŠ¨GPSè®°å½•å™¨              â†â†’    ç›´æ¥å¯åŠ¨GPSè®°å½•å™¨
    â†“                                    â†“
è¿è¡ŒUDPå‘é€ç«¯/æ¥æ”¶ç«¯           â†â†’    è¿è¡ŒUDPæ¥æ”¶ç«¯/å‘é€ç«¯
```

## æ–‡ä»¶ç»“æ„

```
udp-latency/
â”œâ”€â”€ setup.sh                   # ä¸€é”®éƒ¨ç½²è„šæœ¬ â­
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–åŒ…
â”œâ”€â”€ start_test.sh              # æµ‹è¯•å¯åŠ¨è„šæœ¬ â­
â”œâ”€â”€ udp_test_with_ntp.py       # ä¸»æµ‹è¯•ç¨‹åº
â”œâ”€â”€ udp_sender.py              # UDPå‘é€ç«¯
â”œâ”€â”€ udp_receiver.py            # UDPæ¥æ”¶ç«¯
â”œâ”€â”€ gps.py                     # GPSæ•°æ®è®°å½•å™¨
â”œâ”€â”€ nexfi_client.py            # Nexfié€šä¿¡çŠ¶æ€è®°å½•å™¨ â­
â”œâ”€â”€ example_usage.sh           # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ check_environment.sh       # ç¯å¢ƒæ£€æŸ¥è„šæœ¬
â”œâ”€â”€ README_NTP_INTEGRATION.md  # æœ¬æ–‡æ¡£
â”œâ”€â”€ venv/                      # Pythonè™šæ‹Ÿç¯å¢ƒ (setup.shåˆ›å»º)
â”œâ”€â”€ logs/                      # æµ‹è¯•æ—¥å¿—ç›®å½• (è‡ªåŠ¨åˆ›å»º)
â””â”€â”€ backups/                   # å¤‡ä»½ç›®å½• (è‡ªåŠ¨åˆ›å»º)
```

## ç¯å¢ƒè¦æ±‚

### åŸºæœ¬è¦æ±‚ (setup.shä¼šè‡ªåŠ¨å®‰è£…)
- Ubuntu 18.04+ ç³»ç»Ÿ
- Python 3.6+ 
- ç½‘ç»œè¿é€šæ€§ (192.168.104.0/24 ç½‘æ®µ)
- sudo æƒé™ (ç”¨äºé…ç½®NTP)

### GPSè®°å½•é¢å¤–è¦æ±‚ (éœ€æ‰‹åŠ¨å®‰è£…)
- ROS2 ç¯å¢ƒ (Humble/Galactic/Foxy)
- as2_python_api åŒ…
- æ— äººæœºGPSæ¥å£æ­£å¸¸å·¥ä½œ

### Nexfié€šä¿¡çŠ¶æ€è®°å½•é¢å¤–è¦æ±‚ (setup.shä¼šè‡ªåŠ¨å®‰è£…)
- requests åº“ (HTTPè¯·æ±‚)
- Nexfié€šä¿¡æ¨¡å—è®¾å¤‡ (å¯é€‰ï¼Œæ— è®¾å¤‡æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®)
- ç½‘ç»œè¿æ¥åˆ°Nexfiè®¾å¤‡ (é€šå¸¸ä¸º192.168.104.1)

## è¯¦ç»†ä½¿ç”¨è¯´æ˜

### æ–‡ä»¶éƒ¨ç½²

å¦‚æœæ‚¨æ²¡æœ‰ä½¿ç”¨setup.shè‡ªåŠ¨éƒ¨ç½²ï¼Œå¯ä»¥æ‰‹åŠ¨å°†ä»¥ä¸‹æ–‡ä»¶éƒ¨ç½²åˆ°ä¸¤å°æ— äººæœºçš„ç›¸åŒç›®å½•ï¼š
```
udp_test_with_ntp.py    # ä¸»æµ‹è¯•è„šæœ¬
start_test.sh           # å¯åŠ¨è„šæœ¬
udp_sender.py          # UDPå‘é€ç«¯
udp_receiver.py        # UDPæ¥æ”¶ç«¯
gps.py                 # GPSæ•°æ®è®°å½•å™¨
```

### è¿è¡Œæµ‹è¯•

#### åŸºæœ¬æµ‹è¯•ï¼ˆé»˜è®¤å¯ç”¨NTPå¯¹æ—¶ï¼‰

**æ— äººæœºA (192.168.104.10) - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20
```

#### è·³è¿‡NTPå¯¹æ—¶çš„çº¯UDPæµ‹è¯• ğŸ†•

**ä½¿ç”¨åœºæ™¯**: 
- å·²æœ‰å…¶ä»–æ—¶é—´åŒæ­¥æœºåˆ¶
- æµ‹è¯•çº¯UDPæ€§èƒ½ï¼Œä¸éœ€è¦ç²¾ç¡®æ—¶é—´åŒæ­¥
- ä¸´æ—¶æµ‹è¯•æˆ–æ•…éšœæ’é™¤

**æ— äººæœºA (192.168.104.10) - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --skip-ntp
```

**æ— äººæœºB (192.168.104.20) - æ¥æ”¶ç«¯**
```bash
source venv/bin/activate
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --skip-ntp
```

#### ä½¿ç”¨ç‹¬ç«‹NTPå¯¹æ—¶IP ğŸ†•

**ä½¿ç”¨åœºæ™¯**:
- UDPé€šä¿¡ç½‘ç»œä¸ç®¡ç†ç½‘ç»œåˆ†ç¦»
- å¤šç½‘å¡ç¯å¢ƒï¼Œä¸åŒç½‘å¡æ‰¿æ‹…ä¸åŒåŠŸèƒ½
- ç½‘ç»œå®‰å…¨è¦æ±‚ï¼Œæ—¶é—´åŒæ­¥ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ

**æ— äººæœºA - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.10 \
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.1.10
```

**æ— äººæœºB - æ¥æ”¶ç«¯**
```bash
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.20 \
  --peer-ip=192.168.104.10 \
  --ntp-peer-ip=192.168.1.10
```

#### å®Œæ•´æµ‹è¯•ï¼ˆå«GPSè®°å½•ï¼‰

**æ— äººæœºA (192.168.104.10) - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --enable-gps --drone-id=drone0
```

**æ— äººæœºB (192.168.104.20) - æ¥æ”¶ç«¯**
```bash
source venv/bin/activate
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --enable-gps --drone-id=drone1
```

#### å®Œæ•´æµ‹è¯•ï¼ˆå«Nexfié€šä¿¡çŠ¶æ€è®°å½•ï¼‰

**æ— äººæœºA (192.168.104.10) - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --enable-nexfi --nexfi-ip=192.168.104.1
```

**æ— äººæœºB (192.168.104.20) - æ¥æ”¶ç«¯**
```bash
source venv/bin/activate
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --enable-nexfi --nexfi-ip=192.168.104.1
```

#### å…¨åŠŸèƒ½æµ‹è¯•ï¼ˆGPS + Nexfi + UDPï¼Œè·³è¿‡NTPï¼‰ğŸ†•

**åœºæ™¯**: åœ¨å·²æœ‰ç²¾ç¡®æ—¶é—´åŒæ­¥çš„ç¯å¢ƒä¸­è¿›è¡Œå…¨åŠŸèƒ½æµ‹è¯•

**æ— äººæœºA (192.168.104.10) - å‘é€ç«¯**
```bash
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.10 \
  --peer-ip=192.168.104.20 \
  --enable-gps \
  --drone-id=drone0 \
  --enable-nexfi \
  --nexfi-ip=192.168.104.1 \
  --time=300 \
  --skip-ntp
```

**æ— äººæœºB (192.168.104.20) - æ¥æ”¶ç«¯**
```bash
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.20 \
  --peer-ip=192.168.104.10 \
  --enable-gps \
  --drone-id=drone1 \
  --enable-nexfi \
  --nexfi-ip=192.168.104.1 \
  --time=300 \
  --skip-ntp
```

#### é«˜çº§é…ç½®ç¤ºä¾‹ ğŸ†•

**å¤æ‚ç½‘ç»œç¯å¢ƒé…ç½®**:

**å‘é€ç«¯ï¼ˆsenderï¼‰- æ— äººæœºA**:
```bash
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.10 \         # UDPé€šä¿¡IP
  --peer-ip=192.168.104.20 \          # UDPé€šä¿¡å¯¹æ–¹IP
  --ntp-peer-ip=10.0.0.10 \           # æœ¬æœºNTPå¯¹æ—¶ä¸“ç”¨IPï¼ˆå¿…é¡»æ˜¯æœ¬æœºæ¥å£IPï¼‰
  --enable-gps \
  --drone-id=drone_alpha \
  --enable-nexfi \
  --nexfi-ip=172.16.1.1 \            # Nexfiç®¡ç†IP
  --time=600 \
  --frequency=20 \
  --packet-size=1400
```

**æ¥æ”¶ç«¯ï¼ˆreceiverï¼‰- æ— äººæœºB**:
```bash
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.20 \         # UDPé€šä¿¡IP
  --peer-ip=192.168.104.10 \          # UDPé€šä¿¡å¯¹æ–¹IP
  --ntp-peer-ip=10.0.0.10 \           # è¿æ¥åˆ°senderçš„NTPæœåŠ¡å™¨IPï¼ˆä¸senderç›¸åŒï¼‰
  --enable-gps \
  --drone-id=drone_beta \
  --enable-nexfi \
  --nexfi-ip=172.16.1.2 \            # Nexfiç®¡ç†IP
  --time=600
```

**ç½‘ç»œè§„åˆ’è¯´æ˜**:
- **UDPé€šä¿¡ç½‘æ®µ**: 192.168.104.x (æ•°æ®ä¼ è¾“)
- **NTPå¯¹æ—¶ç½‘æ®µ**: 10.0.0.x (æ—¶é—´åŒæ­¥ä¸“ç”¨)
- **Nexfiç®¡ç†ç½‘æ®µ**: 172.16.1.x (è®¾å¤‡ç®¡ç†)
- **senderçš„NTPæœåŠ¡å™¨**: å¿…é¡»åœ¨10.0.0.10ä¸Šå¯åŠ¨
- **receiverçš„NTPå®¢æˆ·ç«¯**: å¿…é¡»è¿æ¥åˆ°10.0.0.10

#### é™æ€è·¯ç”±é…ç½®ç¤ºä¾‹ ğŸ†•

**ä½¿ç”¨åœºæ™¯**: å½“æœ¬åœ°IPéœ€è¦é€šè¿‡ç‰¹å®šç½‘å…³è¿›è¡Œè·¯ç”±æ—¶ï¼Œæ¯”å¦‚æ— äººæœºæœ¬åœ°IPéœ€è¦é€šè¿‡Nexfiè®¾å¤‡ä½œä¸ºç½‘å…³è·¯ç”±ã€‚

**é™æ€è·¯ç”±é…ç½®**:

**å‘é€ç«¯ï¼ˆsenderï¼‰- åŒ…å«é™æ€è·¯ç”±**:
```bash
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.112 \         # æœ¬åœ°UDPé€šä¿¡IP
  --peer-ip=192.168.104.109 \          # UDPé€šä¿¡å¯¹æ–¹IP
  --ntp-peer-ip=192.168.0.200 \        # NTPå¯¹æ—¶ä¸“ç”¨IP
  --enable-nexfi \
  --nexfi-ip=192.168.104.12 \          # Nexfiè®¾å¤‡IPï¼ˆä½œä¸ºç½‘å…³ï¼‰
  --enable-static-route \              # å¯ç”¨é™æ€è·¯ç”±é…ç½®
  --time=120
```

**æ¥æ”¶ç«¯ï¼ˆreceiverï¼‰- åŒ…å«é™æ€è·¯ç”±**:
```bash
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.109 \         # æœ¬åœ°UDPé€šä¿¡IP
  --peer-ip=192.168.104.112 \          # UDPé€šä¿¡å¯¹æ–¹IP
  --ntp-peer-ip=192.168.0.200 \        # NTPå¯¹æ—¶ä¸“ç”¨IPï¼ˆè¿æ¥åˆ°senderï¼‰
  --enable-nexfi \
  --nexfi-ip=192.168.104.15 \          # Nexfiè®¾å¤‡IPï¼ˆä½œä¸ºç½‘å…³ï¼‰
  --enable-static-route \              # å¯ç”¨é™æ€è·¯ç”±é…ç½®
  --time=120
```

**é™æ€è·¯ç”±åŠŸèƒ½è¯´æ˜**:
- **è‡ªåŠ¨æ‰§è¡Œ**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œ `ip route add [local-ip]/32 via [nexfi-ip]`
- **æ™ºèƒ½æ£€æµ‹**: æ£€æŸ¥è·¯ç”±æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤é…ç½®
- **ç½‘å…³éªŒè¯**: è‡ªåŠ¨pingæ£€æµ‹ç½‘å…³è¿é€šæ€§
- **æƒé™æ£€æŸ¥**: éœ€è¦sudoæƒé™é…ç½®è·¯ç”±
- **è‡ªåŠ¨æ¸…ç†**: è„šæœ¬é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†é…ç½®çš„é™æ€è·¯ç”± ğŸ†•
- **æ•…éšœå¤„ç†**: é…ç½®å¤±è´¥æ—¶æä¾›è¯¦ç»†è¯Šæ–­ä¿¡æ¯

**å®é™…æ‰§è¡Œçš„è·¯ç”±å‘½ä»¤**:
```bash
# å‘é€ç«¯ä¼šæ‰§è¡Œï¼š
sudo ip route add 192.168.104.112/32 via 192.168.104.12

# æ¥æ”¶ç«¯ä¼šæ‰§è¡Œï¼š
sudo ip route add 192.168.104.109/32 via 192.168.104.15
```

**é€‚ç”¨åœºæ™¯**:
- âœ… æ— äººæœºIPéœ€è¦é€šè¿‡Nexfiè®¾å¤‡è·¯ç”±
- âœ… å¤æ‚ç½‘ç»œæ‹“æ‰‘ï¼Œéœ€è¦æŒ‡å®šç‰¹å®šç½‘å…³
- âœ… å¤šè·³ç½‘ç»œç¯å¢ƒï¼Œæœ¬åœ°IPä¸åœ¨ç›´è¿ç½‘æ®µ
- âœ… ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œå¼ºåˆ¶é€šè¿‡ç‰¹å®šè·¯å¾„

## æ–°å¢å‘½ä»¤è¡Œå‚æ•°è¯¦è§£ ğŸ†•

### æ—¶é—´ç›¸å…³å‚æ•° ğŸ†•

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--time` | int | 60 | UDPé€šä¿¡æ—¶é—´(ç§’)ï¼Œä¸åŒ…æ‹¬å‡†å¤‡æ—¶é—´ |

**æ—¶é—´é…ç½®é€»è¾‘**:
- **å‘é€ç«¯æ€»æ—¶é—´** = å‡†å¤‡æ—¶é—´ + UDPé€šä¿¡æ—¶é—´
- **æ¥æ”¶ç«¯æ€»æ—¶é—´** = å‡†å¤‡æ—¶é—´ + UDPé€šä¿¡æ—¶é—´ + ç¼“å†²æ—¶é—´
- **å‡†å¤‡æ—¶é—´**: NTPå¯¹æ—¶(~10-30s) + GPSå¯åŠ¨(~5s) + Nexfiå¯åŠ¨(~5s) + å…¶ä»–åˆå§‹åŒ–
- **ç¼“å†²æ—¶é—´**: max(60ç§’, UDPé€šä¿¡æ—¶é—´ Ã— 20%)

**ç¤ºä¾‹**:
```bash
# è®¾ç½®300ç§’UDPé€šä¿¡æ—¶é—´
./start_test.sh sender --time=300
# å‘é€ç«¯: å‡†å¤‡~60s + UDPå‘é€300s = æ€»è®¡~360s

./start_test.sh receiver --time=300  
# æ¥æ”¶ç«¯: å‡†å¤‡~60s + UDPæ¥æ”¶300s + ç¼“å†²60s = æ€»è®¡~420s
```

### NTPç›¸å…³å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--skip-ntp` | flag | false | å®Œå…¨è·³è¿‡NTPæ—¶é—´åŒæ­¥åŠŸèƒ½ |
| `--ntp-peer-ip` | string | ä½¿ç”¨--peer-ipçš„å€¼ | NTPæœåŠ¡å™¨IPåœ°å€ï¼ˆé‡è¦ï¼šä¸¤å°æœºå™¨å¡«å†™ç›¸åŒå€¼ï¼Œå¿…é¡»æ˜¯senderæœºå™¨çš„æ¥å£IPï¼‰ |
| `--skip-ntp-config` | flag | false | è·³è¿‡chronyé…ç½®ï¼Œä½¿ç”¨ç°æœ‰é…ç½® |

#### `--ntp-peer-ip` å‚æ•°è¯¦ç»†è¯´æ˜ ğŸ”‘

**å…³é”®ç‚¹**: 
- **ä¸¤å°æœºå™¨å¡«å†™ç›¸åŒçš„IPåœ°å€**
- **è¿™ä¸ªIPåœ°å€å¿…é¡»æ˜¯senderæœºå™¨ä¸ŠçœŸå®å­˜åœ¨çš„ç½‘ç»œæ¥å£IP**
- **sender**: åœ¨è¿™ä¸ªIPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨
- **receiver**: è¿æ¥åˆ°è¿™ä¸ªIPçš„NTPæœåŠ¡å™¨

**é»˜è®¤è¡Œä¸ºé—®é¢˜ä¿®æ­£** âš ï¸:
```bash
# å¦‚æœä¸æŒ‡å®š--ntp-peer-ipï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨--peer-ipçš„å€¼
# ä½†è¿™é€šå¸¸æ˜¯é”™è¯¯çš„é…ç½®ï¼

# é”™è¯¯çš„é»˜è®¤è¡Œä¸ºç¤ºä¾‹ï¼š
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20
# ç³»ç»Ÿä¼šå°è¯•åœ¨192.168.104.20ä¸Šå¯åŠ¨NTPæœåŠ¡å™¨ï¼ˆé”™è¯¯ï¼ï¼‰

# æ­£ç¡®çš„é…ç½®ï¼š
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --ntp-peer-ip=192.168.104.10
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --ntp-peer-ip=192.168.104.10
```

**æ¨èé…ç½®æ¨¡å¼**:

| é…ç½®æ¨¡å¼ | senderçš„--ntp-peer-ip | receiverçš„--ntp-peer-ip | è¯´æ˜ |
|----------|----------------------|------------------------|------|
| **å•ç½‘å¡æ¨¡å¼** | senderçš„--local-ip | senderçš„--local-ip | NTPå’ŒUDPä½¿ç”¨åŒä¸€ç½‘æ®µ |
| **åŒç½‘å¡æ¨¡å¼** | senderçš„ä¸“ç”¨NTPæ¥å£IP | senderçš„ä¸“ç”¨NTPæ¥å£IP | NTPå’ŒUDPä½¿ç”¨ä¸åŒç½‘æ®µ |
| **é»˜è®¤æ¨¡å¼** | æ˜ç¡®æŒ‡å®š | æ˜ç¡®æŒ‡å®š | é¿å…ä½¿ç”¨é»˜è®¤å€¼ï¼Œæ˜ç¡®æŒ‡å®šæ›´å®‰å…¨ |

### ä½¿ç”¨åœºæ™¯è¯´æ˜

#### ä½•æ—¶ä½¿ç”¨æ–°çš„æ—¶é—´é…ç½®
- âœ… éœ€è¦ç²¾ç¡®æ§åˆ¶UDPé€šä¿¡æ—¶é•¿
- âœ… ä¸¤ç«¯å¯åŠ¨æ—¶æœºä¸åŒæ­¥çš„ç¯å¢ƒ
- âœ… é•¿æ—¶é—´æµ‹è¯•ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼Œéœ€è¦å¯é¢„æµ‹çš„æ—¶é—´

#### ä½•æ—¶ä½¿ç”¨ `--skip-ntp`
- âœ… ç³»ç»Ÿå·²æœ‰å…¶ä»–æ—¶é—´åŒæ­¥æœºåˆ¶ï¼ˆå¦‚GPSæ—¶é’Ÿã€PTPç­‰ï¼‰
- âœ… æµ‹è¯•çº¯UDPæ€§èƒ½ï¼Œä¸å…³å¿ƒæ—¶é—´æˆ³ç²¾åº¦
- âœ… ä¸´æ—¶æµ‹è¯•æˆ–æ•…éšœæ’é™¤
- âœ… ä¸å…·å¤‡sudoæƒé™é…ç½®chrony
- âŒ éœ€è¦ç²¾ç¡®æµ‹é‡ç½‘ç»œå»¶è¿Ÿæ—¶

#### ä½•æ—¶ä½¿ç”¨ `--ntp-peer-ip`
- âœ… å¤šç½‘å¡ç¯å¢ƒï¼Œç®¡ç†ç½‘ç»œä¸æ•°æ®ç½‘ç»œåˆ†ç¦»
- âœ… å®‰å…¨è¦æ±‚ï¼Œæ—¶é—´åŒæ­¥ä½¿ç”¨ä¸“ç”¨å®‰å…¨ç½‘ç»œ
- âœ… ç½‘ç»œæ‹“æ‰‘å¤æ‚ï¼Œæœ€ä¼˜è·¯ç”±ä¸åŒ
- âœ… å¸¦å®½ç®¡ç†ï¼Œé¿å…NTPæµé‡å½±å“æ•°æ®ä¼ è¾“

## æ—¥å¿—æ–‡ä»¶è¯´æ˜

æµ‹è¯•å®Œæˆåï¼Œä¼šåœ¨æŒ‡å®šçš„æ—¥å¿—ç›®å½•ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

### NTPåŒæ­¥æ—¥å¿—
- `ntp_sync_YYYYMMDD_HHMMSS.log`: NTPåŒæ­¥è¿‡ç¨‹æ—¥å¿—
- `system_monitor.jsonl`: ç³»ç»ŸçŠ¶æ€ç›‘æ§æ—¥å¿— (JSON Linesæ ¼å¼)

### UDPæµ‹è¯•æ—¥å¿—
- `udp_sender_YYYYMMDD_HHMMSS.csv`: å‘é€ç«¯æ—¥å¿—
- `udp_receiver_YYYYMMDD_HHMMSS.csv`: æ¥æ”¶ç«¯æ—¥å¿—
- `udp_test_YYYYMMDD_HHMMSS.log`: æµ‹è¯•è¿‡ç¨‹æ—¥å¿—

### GPSè®°å½•æ—¥å¿—
- `gps_logger_[drone_id]_YYYYMMDD_HHMMSS.csv`: GPSä½ç½®å’ŒçŠ¶æ€æ—¥å¿—

### Nexfié€šä¿¡çŠ¶æ€æ—¥å¿—
- `nexfi_status_YYYYMMDD_HHMMSS.csv`: Nexfié€šä¿¡æ¨¡å—çŠ¶æ€å’Œé“¾è·¯è´¨é‡æ—¥å¿—

### æ—¥å¿—æ ¼å¼ç¤ºä¾‹

**å‘é€ç«¯æ—¥å¿— (CSV)**:
```csv
seq_num,timestamp,packet_size
1,1640995200.123456,200
2,1640995200.223456,200
```

**æ¥æ”¶ç«¯æ—¥å¿— (CSV)**:
```csv
seq_num,send_timestamp,recv_timestamp,delay,src_ip,src_port,packet_size
1,1640995200.123456,1640995200.125456,0.002,192.168.104.10,20002,200
2,1640995200.223456,1640995200.225456,0.002,192.168.104.10,20002,200
```

**GPSè®°å½•æ—¥å¿— (CSV)**:
```csv
timestamp,latitude,longitude,altitude,local_x,local_y,local_z,connected,armed,offboard
1640995200.123456,39.123456,116.123456,100.5,10.2,5.3,2.1,true,true,false
1640995201.123456,39.123457,116.123457,100.6,10.3,5.4,2.2,true,true,false
```

**Nexfié€šä¿¡çŠ¶æ€æ—¥å¿— (CSV)**:
```csv
timestamp,mesh_enabled,channel,frequency_band,tx_power,work_mode,node_id,connected_nodes,avg_rssi,avg_snr,throughput,cpu_usage,memory_usage,uptime,firmware_version,topology_nodes,link_quality
1640995200.123456,True,149,20,20,adhoc,1,2,-65.5,25.3,45.2,15%,42%,2h 30m,v1.0.0,3,180.5
1640995201.123456,True,149,20,20,adhoc,1,2,-66.1,24.8,44.8,16%,43%,2h 30m,v1.0.0,3,179.2
```

**ç³»ç»Ÿç›‘æ§æ—¥å¿— (JSON Lines)** ğŸ†•:
```json
{"timestamp": "2021-12-31T12:00:00.123456", "ntp_enabled": true, "ntp_role": "client", "ntp_synced": true, "ntp_offset_ms": 2.3, "gps_logger_status": "running", "enable_gps": true, "nexfi_logger_status": "running", "enable_nexfi": true}
{"timestamp": "2021-12-31T12:00:10.123456", "ntp_enabled": true, "ntp_role": "client", "ntp_synced": true, "ntp_offset_ms": 1.8, "gps_logger_status": "running", "enable_gps": true, "nexfi_logger_status": "running", "enable_nexfi": true}
{"timestamp": "2021-12-31T12:00:20.123456", "ntp_enabled": false, "ntp_role": null, "ntp_synced": null, "ntp_offset_ms": null, "gps_logger_status": "running", "enable_gps": true, "nexfi_logger_status": "stopped", "enable_nexfi": false}
```

**ç³»ç»Ÿç›‘æ§æ—¥å¿—å­—æ®µè¯´æ˜** ğŸ†•:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| timestamp | string | ISOæ ¼å¼æ—¶é—´æˆ³ |
| ntp_enabled | bool | æ˜¯å¦å¯ç”¨NTPæ—¶é—´åŒæ­¥ |
| ntp_role | string/null | NTPè§’è‰² ("server"/"client"/null) |
| ntp_synced | bool/null | NTPåŒæ­¥çŠ¶æ€ (å¯ç”¨NTPæ—¶) |
| ntp_offset_ms | float/null | æ—¶é—´åç§»é‡æ¯«ç§’ (å¯ç”¨NTPæ—¶) |
| gps_logger_status | string | GPSè®°å½•å™¨çŠ¶æ€ ("running"/"stopped") |
| enable_gps | bool | æ˜¯å¦å¯ç”¨GPSè®°å½• |
| nexfi_logger_status | string | Nexfiè®°å½•å™¨çŠ¶æ€ ("running"/"stopped") |
| enable_nexfi | bool | æ˜¯å¦å¯ç”¨NexfiçŠ¶æ€è®°å½• |

## GPSè®°å½•åŠŸèƒ½è¯¦è§£

### GPSæ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| timestamp | float | Unixæ—¶é—´æˆ³ |
| latitude | float | çº¬åº¦ (åº¦) |
| longitude | float | ç»åº¦ (åº¦) |
| altitude | float | æµ·æ‹”é«˜åº¦ (ç±³) |
| local_x | float | æœ¬åœ°åæ ‡X (ç±³) |
| local_y | float | æœ¬åœ°åæ ‡Y (ç±³) |
| local_z | float | æœ¬åœ°åæ ‡Z (ç±³) |
| connected | bool | æ— äººæœºè¿æ¥çŠ¶æ€ |
| armed | bool | æ— äººæœºè§£é”çŠ¶æ€ |
| offboard | bool | Offboardæ¨¡å¼çŠ¶æ€ |

### GPSè®°å½•å™¨ç‹¬ç«‹ä½¿ç”¨

GPSè®°å½•å™¨ä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼š

```bash
# åŸºæœ¬ä½¿ç”¨
python3 gps.py --drone-id=drone0 --interval=1.0 --time=300

# é«˜é¢‘è®°å½•
python3 gps.py --drone-id=drone1 --interval=0.1 --time=600

# ä»¿çœŸç¯å¢ƒ
python3 gps.py --drone-id=drone0 --sim-time --log-path=./sim_logs

# æŸ¥çœ‹å¸®åŠ©
python3 gps.py --help
```

### ROS2ç¯å¢ƒé…ç½®

ç¡®ä¿ROS2ç¯å¢ƒæ­£ç¡®é…ç½®ï¼š

```bash
# æ£€æŸ¥ROS2ç¯å¢ƒ
echo $ROS_DISTRO

# Source ROS2ç¯å¢ƒ
source /opt/ros/humble/setup.bash  # æˆ–å…¶ä»–ç‰ˆæœ¬

# æ£€æŸ¥as2_python_api
python3 -c "from as2_python_api.drone_interface_gps import DroneInterfaceGPS; print('GPSæ¥å£å¯ç”¨')"

# æ£€æŸ¥æ— äººæœºè¿æ¥
ros2 topic list | grep gps
```

## Nexfié€šä¿¡çŠ¶æ€è®°å½•åŠŸèƒ½è¯¦è§£

### Nexfiæ•°æ®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| timestamp | float | Unixæ—¶é—´æˆ³ |
| mesh_enabled | bool | Meshç½‘ç»œæ˜¯å¦å¯ç”¨ |
| channel | str | æ— çº¿ä¿¡é“å· |
| frequency_band | str | é¢‘å®½ (MHz) |
| tx_power | str | å‘å°„åŠŸç‡ (dBm) |
| work_mode | str | å·¥ä½œæ¨¡å¼ (adhoc/ap/client) |
| node_id | str | èŠ‚ç‚¹ID |
| connected_nodes | int | è¿æ¥çš„èŠ‚ç‚¹æ•°é‡ |
| avg_rssi | float | å¹³å‡ä¿¡å·å¼ºåº¦ (dBm) |
| avg_snr | float | å¹³å‡ä¿¡å™ªæ¯” (dB) |
| throughput | str | ååé‡ (Mbps) |
| cpu_usage | str | CPUä½¿ç”¨ç‡ |
| memory_usage | str | å†…å­˜ä½¿ç”¨ç‡ |
| uptime | str | ç³»ç»Ÿè¿è¡Œæ—¶é—´ |
| firmware_version | str | å›ºä»¶ç‰ˆæœ¬ |
| topology_nodes | int | æ‹“æ‰‘ä¸­çš„èŠ‚ç‚¹æ€»æ•° |
| link_quality | float | å¹³å‡é“¾è·¯è´¨é‡ (0-255) |

### Nexfiè®°å½•å™¨ç‹¬ç«‹ä½¿ç”¨

Nexfiè®°å½•å™¨ä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼š

```bash
# åŸºæœ¬ä½¿ç”¨ - è®°å½•åˆ°CSV
python3 nexfi_client.py --nexfi-ip=192.168.104.1 --interval=1.0 --time=300

# è‡ªå®šä¹‰å‚æ•°
python3 nexfi_client.py --nexfi-ip=192.168.104.1 --username=admin --password=mypass --device=wlan0

# ç›‘æ§æ¨¡å¼ - å®æ—¶æ˜¾ç¤ºçŠ¶æ€
python3 nexfi_client.py --nexfi-ip=192.168.104.1 --monitor=5

# ä¿å­˜å½“å‰çŠ¶æ€åˆ°JSON
python3 nexfi_client.py --nexfi-ip=192.168.104.1 --save --output=nexfi_snapshot.json

# æŸ¥çœ‹å¸®åŠ©
python3 nexfi_client.py --help
```

### Nexfiè®¾å¤‡è¿æ¥æµ‹è¯•

åœ¨ä½¿ç”¨å‰å¯ä»¥å…ˆæµ‹è¯•Nexfiè®¾å¤‡è¿æ¥ï¼š

```bash
# æµ‹è¯•HTTPè¿æ¥
curl http://192.168.104.1

# ä½¿ç”¨Pythonæµ‹è¯•
python3 -c "
import requests
try:
    r = requests.get('http://192.168.104.1', timeout=3)
    print('Nexfiè®¾å¤‡å¯è¾¾')
except:
    print('Nexfiè®¾å¤‡ä¸å¯è¾¾')
"
```

### æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼

å½“æ— æ³•è¿æ¥åˆ°Nexfiè®¾å¤‡æ—¶ï¼Œè®°å½•å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç»§ç»­è¿è¡Œï¼Œç¡®ä¿æµ‹è¯•ä¸ä¼šä¸­æ–­ã€‚æ¨¡æ‹Ÿæ•°æ®åŒ…å«åˆç†çš„é»˜è®¤å€¼ï¼Œå¯ç”¨äºæµ‹è¯•å’Œå¼€å‘ã€‚

## æ—¶é—´åŒæ­¥æœºåˆ¶

### NTPè§’è‰²åˆ†é…é€»è¾‘ ğŸ†•

**é‡è¦æ›´æ–°**: ç³»ç»Ÿå·²æ”¹ä¸ºåŸºäº sender/receiver æ¨¡å¼çš„å›ºå®šè§’è‰²åˆ†é…ï¼Œä¸å†æ ¹æ®IPåœ°å€å¤§å°æ¯”è¾ƒã€‚

#### å›ºå®šè§’è‰²åˆ†é…
- **sender å›ºå®šä½œä¸º NTP æœåŠ¡å™¨**: æ— è®ºIPåœ°å€å¤§å°ï¼Œsenderæ€»æ˜¯å¯åŠ¨NTPæœåŠ¡å™¨
- **receiver å›ºå®šä½œä¸º NTP å®¢æˆ·ç«¯**: receiveræ€»æ˜¯è¿æ¥senderçš„NTPæœåŠ¡å™¨è¿›è¡Œæ—¶é—´åŒæ­¥

```
å‘é€ç«¯ (sender)    â†â†’    æ¥æ”¶ç«¯ (receiver)
NTPæœåŠ¡å™¨                 NTPå®¢æˆ·ç«¯
åœ¨æŒ‡å®šIPä¸Šç›‘å¬             è¿æ¥åˆ°æœåŠ¡å™¨IP
```

#### `--ntp-peer-ip` å‚æ•°è¯¦è§£ ğŸ”‘

**å…³é”®ç†è§£**: `--ntp-peer-ip` åœ¨ä¸¤ç§æ¨¡å¼ä¸‹å«ä¹‰ä¸åŒï¼Œä½†æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€

| æ¨¡å¼ | `--ntp-peer-ip` å«ä¹‰ | ä½œç”¨ |
|------|---------------------|------|
| **sender** | æœ¬æœºNTPæœåŠ¡å™¨ç›‘å¬IP | senderåœ¨è¿™ä¸ªIPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨ |
| **receiver** | è¦è¿æ¥çš„NTPæœåŠ¡å™¨IP | receiverè¿æ¥åˆ°è¿™ä¸ªIPçš„NTPæœåŠ¡å™¨ |

**é…ç½®ç¤ºä¾‹**:
```bash
# ä¸¤å°æœºå™¨éƒ½å¡«å†™åŒä¸€ä¸ªIPåœ°å€ï¼š192.168.0.200
# è¿™ä¸ªIPå¿…é¡»æ˜¯senderæœºå™¨ä¸Šçš„ç½‘ç»œæ¥å£IP

# senderæœºå™¨é…ç½®
./start_test.sh sender \
  --local-ip=192.168.104.112 \
  --peer-ip=192.168.104.109 \
  --ntp-peer-ip=192.168.0.200    # senderåœ¨æ­¤IPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨

# receiveræœºå™¨é…ç½®  
./start_test.sh receiver \
  --local-ip=192.168.104.109 \
  --peer-ip=192.168.104.112 \
  --ntp-peer-ip=192.168.0.200    # receiverè¿æ¥åˆ°æ­¤IPçš„NTPæœåŠ¡å™¨
```

#### ç½‘ç»œæ¥å£æ£€æŸ¥

senderä¼šè‡ªåŠ¨æ£€æŸ¥æŒ‡å®šçš„NTPæœåŠ¡å™¨IPæ˜¯å¦å­˜åœ¨äºæœ¬æœºç½‘ç»œæ¥å£ï¼š

```bash
# å¦‚æœ192.168.0.200å­˜åœ¨äºsenderçš„ç½‘ç»œæ¥å£
âœ“ å°†åœ¨æŒ‡å®šIP 192.168.0.200 ä¸Šç›‘å¬

# å¦‚æœ192.168.0.200ä¸å­˜åœ¨äºsenderçš„ç½‘ç»œæ¥å£  
âš ï¸  æŒ‡å®šIP 192.168.0.200 ä¸å­˜åœ¨ï¼Œå°†ç›‘å¬æ‰€æœ‰æ¥å£ (0.0.0.0)
```

#### å¸¸è§é…ç½®åœºæ™¯

**åœºæ™¯1: å•ç½‘å¡ç¯å¢ƒï¼ˆNTPå’ŒUDPä½¿ç”¨åŒä¸€ç½‘æ®µï¼‰**
```bash
# sender
./start_test.sh sender \
  --local-ip=192.168.104.10 \
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.104.10    # ä½¿ç”¨æœ¬æœºUDPé€šä¿¡IPä½œä¸ºNTPæœåŠ¡å™¨IP

# receiver
./start_test.sh receiver \
  --local-ip=192.168.104.20 \
  --peer-ip=192.168.104.10 \
  --ntp-peer-ip=192.168.104.10    # è¿æ¥åˆ°senderçš„UDPé€šä¿¡IP
```

**åœºæ™¯2: åŒç½‘å¡ç¯å¢ƒï¼ˆNTPå’ŒUDPä½¿ç”¨ä¸åŒç½‘æ®µï¼‰**
```bash
# senderæœºå™¨æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼š
# - eth0: 192.168.104.10 (UDPé€šä¿¡ç½‘æ®µ)  
# - eth1: 192.168.0.200 (NTPå¯¹æ—¶ä¸“ç”¨ç½‘æ®µ)

# senderé…ç½®
./start_test.sh sender \
  --local-ip=192.168.104.10 \     # UDPé€šä¿¡ä½¿ç”¨eth0
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.0.200     # NTPæœåŠ¡å™¨ä½¿ç”¨eth1

# receiveré…ç½®
./start_test.sh receiver \
  --local-ip=192.168.104.20 \     # UDPé€šä¿¡ä½¿ç”¨å¯¹åº”æ¥å£
  --peer-ip=192.168.104.10 \  
  --ntp-peer-ip=192.168.0.200     # è¿æ¥åˆ°senderçš„eth1æ¥å£
```

**åœºæ™¯3: é»˜è®¤è¡Œä¸ºï¼ˆä¸æŒ‡å®š--ntp-peer-ipï¼‰**
```bash
# å¦‚æœä¸æŒ‡å®š--ntp-peer-ipï¼Œç³»ç»Ÿä½¿ç”¨--peer-ipçš„å€¼
# sender
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20
# ç­‰ä»·äº: --ntp-peer-ip=192.168.104.20ï¼ˆä½†è¿™æ˜¯é”™è¯¯çš„ï¼ï¼‰

# æ­£ç¡®åšæ³•ï¼šæ˜ç¡®æŒ‡å®šsenderçš„IPä½œä¸ºNTPæœåŠ¡å™¨IP
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --ntp-peer-ip=192.168.104.10
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --ntp-peer-ip=192.168.104.10
```

#### é…ç½®éªŒè¯

**æ£€æŸ¥senderçš„ç½‘ç»œæ¥å£**:
```bash
# åœ¨senderæœºå™¨ä¸Šæ£€æŸ¥ç½‘ç»œæ¥å£
ip addr show

# ç¡®è®¤NTPæœåŠ¡å™¨IPå­˜åœ¨
ip addr show | grep "192.168.0.200"
```

**æ£€æŸ¥NTPè¿é€šæ€§**:
```bash
# åœ¨receiveræœºå™¨ä¸Šæµ‹è¯•NTPæœåŠ¡å™¨è¿é€šæ€§
ping 192.168.0.200

# æµ‹è¯•NTPç«¯å£ï¼ˆUDP 123ï¼‰
nc -u -z -w 3 192.168.0.200 123
```

#### é‡è¦æé†’ âš ï¸

1. **IPåœ°å€è§„åˆ’**: `--ntp-peer-ip` å¿…é¡»æ˜¯senderæœºå™¨ä¸ŠçœŸå®å­˜åœ¨çš„ç½‘ç»œæ¥å£IP
2. **ç½‘ç»œè·¯ç”±**: ç¡®ä¿receiverèƒ½å¤Ÿè·¯ç”±åˆ°senderçš„NTPæœåŠ¡å™¨IP
3. **é˜²ç«å¢™**: ç¡®ä¿NTPç«¯å£ï¼ˆUDP 123ï¼‰æœªè¢«é˜»æ­¢
4. **ä¸€è‡´æ€§**: ä¸¤å°æœºå™¨çš„ `--ntp-peer-ip` å¿…é¡»å¡«å†™ç›¸åŒçš„IPåœ°å€
5. **ç½‘ç»œåˆ†ç¦»**: å¦‚æœä½¿ç”¨ç‹¬ç«‹NTPç½‘ç»œï¼Œç¡®ä¿ä¸¤å°æœºå™¨éƒ½èƒ½è®¿é—®è¯¥ç½‘ç»œ

### åŒæ­¥ç²¾åº¦
- **åˆå§‹åŒæ­¥**: Â±50msä»¥å†…ï¼ˆä»£ç ä¸­çš„é˜ˆå€¼ï¼‰
- **ç¨³å®šè¿è¡Œ**: Â±5-10ms
- **ç½‘ç»œè‰¯å¥½æ—¶**: Â±1-3ms

### ç›‘æ§æœºåˆ¶
- æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡åŒæ­¥çŠ¶æ€
- è‡ªåŠ¨è®°å½•æ—¶é—´åç§»é‡åˆ°ç³»ç»Ÿç›‘æ§æ—¥å¿—
- åŒæ­¥å¼‚å¸¸æ—¶å‘å‡ºè­¦å‘Š
- å®æ—¶æ˜¾ç¤ºåŒæ­¥çŠ¶æ€å’Œåç§»é‡

### æ•…éšœæ¢å¤æœºåˆ¶
- å®¢æˆ·ç«¯è¿æ¥å¤±è´¥æ—¶ä¼šæŒç»­é‡è¯•
- æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ä¼šè‡ªåŠ¨é‡å¯æœåŠ¡
- ç½‘ç»œä¸­æ–­åè‡ªåŠ¨æ¢å¤åŒæ­¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. GPSè®°å½•å™¨å¯åŠ¨å¤±è´¥
**ç—‡çŠ¶**: æ˜¾ç¤º "GPS logger failed to start"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ROS2ç¯å¢ƒ
source /opt/ros/humble/setup.bash

# æ£€æŸ¥æ— äººæœºè¿æ¥
ros2 topic list | grep drone

# æ£€æŸ¥GPSæ¥å£
python3 -c "from as2_python_api.drone_interface_gps import DroneInterfaceGPS"

# æ‰‹åŠ¨æµ‹è¯•GPSè®°å½•å™¨
python3 gps.py --drone-id=drone0 --time=10
```

#### 2. GPSæ•°æ®å…¨ä¸º0
**ç—‡çŠ¶**: GPSåæ ‡æ˜¾ç¤ºä¸º (0.0, 0.0, 0.0)
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥GPSè¯é¢˜
ros2 topic echo /drone0/sensor_measurements/gps

# æ£€æŸ¥æ— äººæœºçŠ¶æ€
ros2 topic echo /drone0/platform/info

# ç­‰å¾…GPSå®šä½
# GPSéœ€è¦ä¸€å®šæ—¶é—´è·å–å®šä½ï¼Œç‰¹åˆ«æ˜¯é¦–æ¬¡å¯åŠ¨
```

#### 3. æ—¶é—´åŒæ­¥å¤±è´¥
**ç—‡çŠ¶**: æ˜¾ç¤º "Time synchronization failed!"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥chronyæœåŠ¡çŠ¶æ€
sudo systemctl status chrony

# æ‰‹åŠ¨é‡å¯chrony
sudo systemctl restart chrony

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status
```

#### 3.1. NTPé…ç½®éªŒè¯å¤±è´¥ ğŸ†•
**ç—‡çŠ¶**: æ˜¾ç¤º "NTPé…ç½®é”™è¯¯" æˆ– "æŒ‡å®šIPä¸å­˜åœ¨" æˆ– "NTPæœåŠ¡å™¨ä¸å¯è¾¾"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ­¥éª¤1: åœ¨senderæœºå™¨ä¸ŠéªŒè¯NTPæœåŠ¡å™¨IPæ˜¯å¦å­˜åœ¨
ip addr show | grep "192.168.0.200"  # æ›¿æ¢ä¸ºæ‚¨çš„--ntp-peer-ipå€¼

# å¦‚æœIPä¸å­˜åœ¨ï¼Œæ·»åŠ IPåœ°å€åˆ°ç½‘ç»œæ¥å£
sudo ip addr add 192.168.0.200/24 dev eth0  # æ ¹æ®å®é™…ç½‘ç»œæ¥å£è°ƒæ•´

# æ­¥éª¤2: åœ¨receiveræœºå™¨ä¸Šæµ‹è¯•NTPæœåŠ¡å™¨è¿é€šæ€§
ping -c 3 192.168.0.200
nc -u -z -w 3 192.168.0.200 123

# æ­¥éª¤3: éªŒè¯NTPé…ç½®å‚æ•°æ˜¯å¦ä¸€è‡´
# ç¡®ä¿ä¸¤å°æœºå™¨çš„--ntp-peer-ipå‚æ•°å€¼å®Œå…¨ç›¸åŒ
echo "senderé…ç½®: --ntp-peer-ip=192.168.0.200"
echo "receiveré…ç½®: --ntp-peer-ip=192.168.0.200"  # å¿…é¡»ç›¸åŒ

# æ­¥éª¤4: æ£€æŸ¥å¸¸è§é…ç½®é”™è¯¯
# âŒ é”™è¯¯ï¼šreceiverä½¿ç”¨è‡ªå·±çš„IP
# ./start_test.sh receiver --ntp-peer-ip=192.168.104.20

# âœ… æ­£ç¡®ï¼šreceiverä½¿ç”¨senderçš„IP  
# ./start_test.sh receiver --ntp-peer-ip=192.168.0.200
```

#### 3.2. --ntp-peer-ipå‚æ•°é…ç½®é”™è¯¯ ğŸ†•
**ç—‡çŠ¶**: 
- senderæ˜¾ç¤º "æŒ‡å®šIPä¸å­˜åœ¨ï¼Œå°†ç›‘å¬æ‰€æœ‰æ¥å£"
- receiveræ˜¾ç¤º "NTPæœåŠ¡å™¨ä¸å¯è¾¾" æˆ– "è¿æ¥è¶…æ—¶"
- æ—¶é—´åŒæ­¥å§‹ç»ˆå¤±è´¥

**è¯Šæ–­æ–¹æ³•**:
```bash
# è¯Šæ–­1: æ£€æŸ¥senderæœºå™¨çš„ç½‘ç»œæ¥å£
echo "=== senderæœºå™¨ç½‘ç»œæ¥å£æ£€æŸ¥ ==="
ip addr show
echo ""
echo "æ£€æŸ¥--ntp-peer-ipæ˜¯å¦åœ¨ä¸Šè¿°æ¥å£ä¸­å‡ºç°"

# è¯Šæ–­2: æ£€æŸ¥receiveråˆ°senderçš„ç½‘ç»œè¿é€šæ€§
echo "=== ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ ==="
ping -c 3 <senderçš„ntp-peer-ip>
traceroute <senderçš„ntp-peer-ip>

# è¯Šæ–­3: æ£€æŸ¥NTPç«¯å£
echo "=== NTPç«¯å£æ£€æŸ¥ ==="
nmap -sU -p 123 <senderçš„ntp-peer-ip>

# è¯Šæ–­4: éªŒè¯é…ç½®å‚æ•°
echo "=== é…ç½®å‚æ•°éªŒè¯ ==="
echo "æ‚¨çš„é…ç½®:"
echo "sender --ntp-peer-ip=<å€¼A>"
echo "receiver --ntp-peer-ip=<å€¼B>"
echo "æ£€æŸ¥: å€¼Aå’Œå€¼Bå¿…é¡»å®Œå…¨ç›¸åŒï¼"
echo "æ£€æŸ¥: è¿™ä¸ªå€¼å¿…é¡»æ˜¯senderæœºå™¨ä¸ŠçœŸå®å­˜åœ¨çš„ç½‘ç»œæ¥å£IPï¼"
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è§£å†³æ–¹æ¡ˆ1: ä¿®æ­£IPåœ°å€é…ç½®
# ç¡®ä¿--ntp-peer-ipä½¿ç”¨senderæœºå™¨ä¸Šå­˜åœ¨çš„IPåœ°å€

# å•ç½‘å¡ç¯å¢ƒæ¨èé…ç½®ï¼š
./start_test.sh sender --local-ip=192.168.104.10 --ntp-peer-ip=192.168.104.10
./start_test.sh receiver --local-ip=192.168.104.20 --ntp-peer-ip=192.168.104.10

# åŒç½‘å¡ç¯å¢ƒæ¨èé…ç½®ï¼š
# 1. ç¡®ä¿senderæœºå™¨æœ‰ä¸“ç”¨NTPæ¥å£
sudo ip addr add 192.168.1.10/24 dev eth1  # æ·»åŠ ä¸“ç”¨NTPæ¥å£
# 2. ä½¿ç”¨ä¸“ç”¨æ¥å£è¿›è¡ŒNTPå¯¹æ—¶
./start_test.sh sender --local-ip=192.168.104.10 --ntp-peer-ip=192.168.1.10
./start_test.sh receiver --local-ip=192.168.104.20 --ntp-peer-ip=192.168.1.10

# è§£å†³æ–¹æ¡ˆ2: ç½‘ç»œè·¯ç”±ä¿®æ­£
# å¦‚æœä½¿ç”¨ä¸åŒç½‘æ®µï¼Œç¡®ä¿è·¯ç”±æ­£ç¡®
sudo route add -net 192.168.1.0/24 gw <gateway-ip>

# è§£å†³æ–¹æ¡ˆ3: é˜²ç«å¢™é…ç½®
# å…è®¸NTPæµé‡é€šè¿‡
sudo ufw allow from any to any port 123 proto udp
sudo ufw allow 123/udp
```

#### 4. å¯¹æ–¹æ— äººæœºä¸å¯è¾¾
**ç—‡çŠ¶**: ping å¯¹æ–¹IPå¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œé…ç½®
ip addr show
ip route show

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 192.168.104.20

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw allow from 192.168.104.0/24
```

#### 5. UDPæµ‹è¯•å¤±è´¥
**ç—‡çŠ¶**: UDPå‘é€/æ¥æ”¶å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -ulnp | grep 20001

# æ£€æŸ¥é˜²ç«å¢™ç«¯å£
sudo ufw allow 20001/udp
sudo ufw allow 20002/udp
```

#### 6. æƒé™ä¸è¶³
**ç—‡çŠ¶**: é…ç½®chronyæ—¶æƒé™é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿ç”¨æˆ·æœ‰sudoæƒé™
sudo -l

# æˆ–è€…æ‰‹åŠ¨é…ç½®chrony
sudo nano /etc/chrony/chrony.conf
```

#### 7. NexfiçŠ¶æ€è®°å½•å™¨å¯åŠ¨å¤±è´¥
**ç—‡çŠ¶**: æ˜¾ç¤º "Nexfi status logger failed to start"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥requestsåº“
pip install requests

# æµ‹è¯•Nexfiè¿æ¥
python3 nexfi_client.py --nexfi-ip=192.168.104.1 --monitor=1

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 192.168.104.1

# æ‰‹åŠ¨æµ‹è¯•API
curl http://192.168.104.1/ubus
```

#### 8. Nexfiæ•°æ®è·å–å¤±è´¥
**ç—‡çŠ¶**: Nexfiæ—¥å¿—æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥Nexfiè®¾å¤‡çŠ¶æ€
# ç¡®ä¿Nexfiè®¾å¤‡å·²å¼€æœºå¹¶æ­£å¸¸å·¥ä½œ

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw allow from 192.168.104.1

# éªŒè¯ç™»å½•å‡­æ®
# ç¡®ä¿ç”¨æˆ·åå’Œå¯†ç æ­£ç¡®

# ä½¿ç”¨æµè§ˆå™¨è®¿é—®
# æ‰“å¼€ http://192.168.104.1 æŸ¥çœ‹Webç•Œé¢
```

### æ‰‹åŠ¨éªŒè¯æ—¶é—´åŒæ­¥

```bash
# æ£€æŸ¥chronyçŠ¶æ€
chronyc tracking
chronyc sources -v

# æ£€æŸ¥æ—¶é—´åç§»
# åœ¨ä¸¤å°æ— äººæœºä¸ŠåŒæ—¶æ‰§è¡Œ
date +%s.%N
```

### GPSæ•°æ®éªŒè¯

```bash
# æ£€æŸ¥GPSæ—¥å¿—æ–‡ä»¶
tail -f ./logs/gps_logger_drone0_*.csv

# éªŒè¯GPSæ•°æ®æ ¼å¼
python3 -c "
import pandas as pd
df = pd.read_csv('./logs/gps_logger_drone0_*.csv')
print(df.head())
print(f'GPSè®°å½•æ•°: {len(df)}')
print(f'æœ‰æ•ˆGPSåæ ‡æ•°: {len(df[(df.latitude != 0) | (df.longitude != 0)])}')
"
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç½‘ç»œä¼˜åŒ–
1. **å‡å°‘ç½‘ç»œå»¶è¿Ÿ**: ä½¿ç”¨æœ‰çº¿è¿æ¥æˆ–é«˜è´¨é‡æ— çº¿é“¾è·¯
2. **QoSè®¾ç½®**: ä¸ºNTPå’ŒUDPæµ‹è¯•æµé‡è®¾ç½®ä¼˜å…ˆçº§
3. **MTUä¼˜åŒ–**: ç¡®ä¿æ•°æ®åŒ…å¤§å°å°äºé“¾è·¯MTU

### ç³»ç»Ÿä¼˜åŒ–
1. **CPUè°ƒåº¦**: è®¾ç½®å®æ—¶è°ƒåº¦ä¼˜å…ˆçº§
2. **ç½‘ç»œç¼“å†²**: è°ƒæ•´ç½‘ç»œç¼“å†²åŒºå¤§å°
3. **æ—¶é’Ÿæº**: ä½¿ç”¨é«˜è´¨é‡çš„ç³»ç»Ÿæ—¶é’Ÿ

### GPSè®°å½•ä¼˜åŒ–
1. **è®°å½•é¢‘ç‡**: æ ¹æ®éœ€æ±‚è°ƒæ•´GPSè®°å½•é—´éš”
2. **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨GPSæ—¥å¿—
3. **ROS2æ€§èƒ½**: ä¼˜åŒ–ROS2èŠ‚ç‚¹é€šä¿¡æ€§èƒ½

### æµ‹è¯•å‚æ•°è°ƒä¼˜
1. **å‘é€é¢‘ç‡**: æ ¹æ®ç½‘ç»œå¸¦å®½è°ƒæ•´å‘é€é¢‘ç‡
2. **åŒ…å¤§å°**: é¿å…IPåˆ†ç‰‡ï¼Œä¿æŒåŒ…å¤§å°é€‚ä¸­
3. **æµ‹è¯•æ—¶é•¿**: è¶³å¤Ÿé•¿çš„æµ‹è¯•æ—¶é—´ä»¥è·å¾—ç»Ÿè®¡æ„ä¹‰

## æ•°æ®åˆ†æå»ºè®®

### GPSè½¨è¿¹åˆ†æ
```python
import pandas as pd
import matplotlib.pyplot as plt

# è¯»å–GPSæ•°æ®
df = pd.read_csv('logs/gps_logger_drone0_*.csv')

# ç»˜åˆ¶è½¨è¿¹å›¾
plt.figure(figsize=(10, 8))
plt.plot(df['longitude'], df['latitude'], 'b-', alpha=0.7)
plt.scatter(df['longitude'].iloc[0], df['latitude'].iloc[0], c='green', s=100, label='èµ·ç‚¹')
plt.scatter(df['longitude'].iloc[-1], df['latitude'].iloc[-1], c='red', s=100, label='ç»ˆç‚¹')
plt.xlabel('ç»åº¦')
plt.ylabel('çº¬åº¦')
plt.title('æ— äººæœºé£è¡Œè½¨è¿¹')
plt.legend()
plt.grid(True)
plt.show()
```

### é€šä¿¡è´¨é‡åˆ†æ
```python
# ç»“åˆGPSå’ŒUDPæ•°æ®åˆ†æé€šä¿¡è´¨é‡ä¸ä½ç½®çš„å…³ç³»
gps_df = pd.read_csv('logs/gps_logger_drone0_*.csv')
udp_df = pd.read_csv('logs/udp_receiver_*.csv')

# æ—¶é—´å¯¹é½å’Œåˆ†æ
# ... åˆ†æä»£ç 
```

### Nexfié€šä¿¡çŠ¶æ€åˆ†æ
```python
import pandas as pd
import matplotlib.pyplot as plt

# è¯»å–NexfiçŠ¶æ€æ•°æ®
nexfi_df = pd.read_csv('logs/nexfi_status_*.csv')

# ç»˜åˆ¶ä¿¡å·å¼ºåº¦å’Œä¿¡å™ªæ¯”å˜åŒ–
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))

# RSSIå˜åŒ–å›¾
ax1.plot(nexfi_df['timestamp'], nexfi_df['avg_rssi'], 'b-')
ax1.set_ylabel('RSSI (dBm)')
ax1.set_title('ä¿¡å·å¼ºåº¦å˜åŒ–')
ax1.grid(True)

# SNRå˜åŒ–å›¾
ax2.plot(nexfi_df['timestamp'], nexfi_df['avg_snr'], 'g-')
ax2.set_ylabel('SNR (dB)')
ax2.set_xlabel('æ—¶é—´æˆ³')
ax2.set_title('ä¿¡å™ªæ¯”å˜åŒ–')
ax2.grid(True)

plt.tight_layout()
plt.show()

# åˆ†æè¿æ¥ç¨³å®šæ€§
print(f"å¹³å‡è¿æ¥èŠ‚ç‚¹æ•°: {nexfi_df['connected_nodes'].mean():.2f}")
print(f"å¹³å‡RSSI: {nexfi_df['avg_rssi'].mean():.2f} dBm")
print(f"å¹³å‡SNR: {nexfi_df['avg_snr'].mean():.2f} dB")
print(f"å¹³å‡é“¾è·¯è´¨é‡: {nexfi_df['link_quality'].mean():.2f}")
```

### ç»¼åˆåˆ†æç¤ºä¾‹
```python
# ç»“åˆUDPå»¶è¿Ÿã€GPSä½ç½®å’ŒNexfiçŠ¶æ€è¿›è¡Œç»¼åˆåˆ†æ
import pandas as pd
import numpy as np

# è¯»å–æ‰€æœ‰æ•°æ®
udp_df = pd.read_csv('logs/udp_receiver_*.csv')
gps_df = pd.read_csv('logs/gps_logger_*.csv')
nexfi_df = pd.read_csv('logs/nexfi_status_*.csv')

# æ—¶é—´å¯¹é½ï¼ˆä½¿ç”¨æœ€è¿‘é‚»åŒ¹é…ï¼‰
def align_data(df1, df2, time_col='timestamp'):
    merged = pd.merge_asof(
        df1.sort_values(time_col),
        df2.sort_values(time_col),
        on=time_col,
        direction='nearest',
        tolerance=1.0  # 1ç§’å®¹å·®
    )
    return merged

# åˆå¹¶æ•°æ®
combined = align_data(udp_df, gps_df)
combined = align_data(combined, nexfi_df)

# åˆ†æå»¶è¿Ÿä¸ä¿¡å·è´¨é‡çš„å…³ç³»
correlation = combined[['delay', 'avg_rssi', 'avg_snr']].corr()
print("å»¶è¿Ÿä¸ä¿¡å·è´¨é‡ç›¸å…³æ€§:")
print(correlation)
```

## æ³¨æ„äº‹é¡¹

1. **sudoæƒé™**: é…ç½®NTPéœ€è¦sudoæƒé™ï¼ˆä½¿ç”¨--skip-ntpæ—¶ä¸éœ€è¦ï¼‰ğŸ†•
2. **ç½‘ç»œç¨³å®š**: ç¡®ä¿æµ‹è¯•æœŸé—´ç½‘ç»œè¿æ¥ç¨³å®š
3. **æ—¶é—´åŒæ­¥**: æµ‹è¯•å‰ç¡®ä¿æ—¶é—´åŒæ­¥æˆåŠŸï¼ˆå¯ç”¨NTPæ—¶ï¼‰ğŸ†•
4. **æ—¶é—´é…ç½®**: --timeå‚æ•°æ˜¯UDPé€šä¿¡æ—¶é—´ï¼Œæ¥æ”¶ç«¯ä¼šè‡ªåŠ¨å¢åŠ ç¼“å†²æ—¶é—´ ğŸ†•
5. **å¯åŠ¨æ—¶æœº**: å»ºè®®ä¸¤ç«¯å°½é‡åŒæ—¶å¯åŠ¨ï¼Œé¿å…è¿‡å¤§çš„æ—¶é—´å·® ğŸ†•
6. **é˜²ç«å¢™**: ç¡®ä¿ç›¸å…³ç«¯å£æœªè¢«é˜²ç«å¢™é˜»æ­¢
7. **ç³»ç»Ÿè´Ÿè½½**: é¿å…åœ¨é«˜è´Ÿè½½æ—¶è¿›è¡Œæµ‹è¯•
8. **ROS2ç¯å¢ƒ**: GPSè®°å½•éœ€è¦æ­£ç¡®é…ç½®çš„ROS2ç¯å¢ƒ
9. **GPSä¿¡å·**: ç¡®ä¿GPSä¿¡å·è‰¯å¥½ï¼Œç‰¹åˆ«æ˜¯åœ¨å®¤å¤–ç¯å¢ƒ
10. **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨æ—¥å¿—æ–‡ä»¶
11. **Nexfiè®¾å¤‡**: ç¡®ä¿Nexfiè®¾å¤‡æ­£å¸¸å·¥ä½œå¹¶å¯è®¿é—®
12. **ç½‘ç»œæƒé™**: Nexfi APIè®¿é—®éœ€è¦æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç 
13. **å¤šç½‘å¡ç¯å¢ƒ**: ä½¿ç”¨--ntp-peer-ipæ—¶ç¡®ä¿NTPç½‘ç»œè·¯ç”±æ­£ç¡® ğŸ†•
14. **æµ‹è¯•æ—¶é•¿**: é•¿æ—¶é—´æµ‹è¯•(>10åˆ†é’Ÿ)å»ºè®®ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ ğŸ†•
15. **æ•°æ®å®Œæ•´æ€§**: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ç¡®ä¿æ¥æ”¶ç«¯æ¥æ”¶åˆ°å®Œæ•´çš„æ•°æ®åŒ… ğŸ†•

## æ–°åŠŸèƒ½æµ‹è¯•ç¤ºä¾‹ ğŸ†•

### æµ‹è¯•åœºæ™¯1: æ—¶é—´é…ç½®éªŒè¯ ğŸ†•

**ç›®æ ‡**: éªŒè¯æ–°çš„æ—¶é—´é…ç½®é€»è¾‘æ˜¯å¦æ­£ç¡®å·¥ä½œ

```bash
# çŸ­æ—¶é—´æµ‹è¯• (60ç§’)
./start_test.sh sender --time=60 > sender_60s.log 2>&1 &
./start_test.sh receiver --time=60 > receiver_60s.log 2>&1

# æ£€æŸ¥å®é™…è¿è¡Œæ—¶é—´
grep "æ€»è¿è¡Œæ—¶é—´" sender_60s.log receiver_60s.log
grep "UDPé€šä¿¡æ—¶é—´" sender_60s.log receiver_60s.log
grep "ç¼“å†²æ—¶é—´" receiver_60s.log

# é•¿æ—¶é—´æµ‹è¯• (300ç§’)
./start_test.sh sender --time=300 > sender_300s.log 2>&1 &
./start_test.sh receiver --time=300 > receiver_300s.log 2>&1

# éªŒè¯æ¥æ”¶ç«¯æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç¼“å†²æ—¶é—´
grep "ç¼“å†²æ—¶é—´" receiver_300s.log  # åº”è¯¥æ˜¾ç¤º60ç§’ç¼“å†²æ—¶é—´
```

**é¢„æœŸç»“æœ**:
- å‘é€ç«¯: å‡†å¤‡~60s + UDPå‘é€60s = æ€»è®¡~120s
- æ¥æ”¶ç«¯: å‡†å¤‡~60s + UDPæ¥æ”¶60s + ç¼“å†²60s = æ€»è®¡~180s
- æ¥æ”¶ç«¯åº”è¯¥èƒ½å®Œæ•´æ¥æ”¶æ‰€æœ‰æ•°æ®åŒ…

### æµ‹è¯•åœºæ™¯2: è·³è¿‡NTPå¯¹æ—¶çš„å¿«é€ŸUDPæµ‹è¯•

**é€‚ç”¨æƒ…å†µ**: ç³»ç»Ÿå·²æœ‰å…¶ä»–æ—¶é—´åŒæ­¥æœºåˆ¶ï¼Œæˆ–åªéœ€æµ‹è¯•UDPæ€§èƒ½

```bash
# æ— äººæœºA - å‘é€ç«¯
source venv/bin/activate
./start_test.sh sender --skip-ntp --time=120 --frequency=20 --packet-size=1400

# æ— äººæœºB - æ¥æ”¶ç«¯
source venv/bin/activate
./start_test.sh receiver --skip-ntp --time=120
```

**é¢„æœŸç»“æœ**: 
- è·³è¿‡æ‰€æœ‰NTPé…ç½®æ­¥éª¤
- å‘é€ç«¯: å‡†å¤‡~20s + UDPå‘é€120s = æ€»è®¡~140s
- æ¥æ”¶ç«¯: å‡†å¤‡~20s + UDPæ¥æ”¶120s + ç¼“å†²60s = æ€»è®¡~200s
- ç³»ç»Ÿç›‘æ§æ—¥å¿—ä¸­ `ntp_enabled` ä¸º `false`

### æµ‹è¯•åœºæ™¯3: åŒç½‘å¡ç¯å¢ƒï¼ˆç®¡ç†ç½‘ç»œ+æ•°æ®ç½‘ç»œï¼‰

**ç½‘ç»œé…ç½®**:
- ç®¡ç†ç½‘ç»œ: 192.168.1.x (ç”¨äºNTPæ—¶é—´åŒæ­¥)
- æ•°æ®ç½‘ç»œ: 192.168.104.x (ç”¨äºUDPé€šä¿¡)

```bash
# æ— äººæœºA - å‘é€ç«¯
source venv/bin/activate
./start_test.sh sender \
  --local-ip=192.168.104.10 \
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.1.20 \
  --time=300

# æ— äººæœºB - æ¥æ”¶ç«¯
source venv/bin/activate
./start_test.sh receiver \
  --local-ip=192.168.104.20 \
  --peer-ip=192.168.104.10 \
  --ntp-peer-ip=192.168.1.10 \
  --time=300
```

**é¢„æœŸç»“æœ**:
- NTPåŒæ­¥é€šè¿‡192.168.1.xç½‘ç»œ
- UDPé€šä¿¡é€šè¿‡192.168.104.xç½‘ç»œ
- å‘é€ç«¯: å‡†å¤‡~60s + UDPå‘é€300s = æ€»è®¡~360s
- æ¥æ”¶ç«¯: å‡†å¤‡~60s + UDPæ¥æ”¶300s + ç¼“å†²60s = æ€»è®¡~420s
- ä¸¤ä¸ªç½‘ç»œå¯ä»¥ç‹¬ç«‹ä¼˜åŒ–å’Œç®¡ç†

### æµ‹è¯•åœºæ™¯4: éªŒè¯NTPå‚æ•°åŠŸèƒ½

**æ­¥éª¤1**: è¿è¡Œæ ‡å‡†NTPåŒæ­¥æµ‹è¯•
```bash
# è®°å½•æ ‡å‡†æ¨¡å¼çš„æ—¶é—´åç§»é‡
./start_test.sh sender --time=60 > standard_ntp.log 2>&1
```

**æ­¥éª¤2**: è¿è¡Œè·³è¿‡NTPçš„æµ‹è¯•
```bash
# è®°å½•è·³è¿‡NTPæ¨¡å¼çš„æ€§èƒ½
./start_test.sh sender --skip-ntp --time=60 > skip_ntp.log 2>&1
```

**æ­¥éª¤3**: æ¯”è¾ƒç»“æœ
```bash
# æŸ¥çœ‹NTPçŠ¶æ€å·®å¼‚
grep "NTP" standard_ntp.log skip_ntp.log
grep "è·³è¿‡" standard_ntp.log skip_ntp.log

# æ£€æŸ¥æ—¶é—´é…ç½®å·®å¼‚
grep "å‡†å¤‡æ—¶é—´" standard_ntp.log skip_ntp.log
grep "UDPé€šä¿¡æ—¶é—´" standard_ntp.log skip_ntp.log

# æ£€æŸ¥ç³»ç»Ÿç›‘æ§æ—¥å¿—å·®å¼‚
tail -5 logs/system_monitor.jsonl | jq '.ntp_enabled'
```

### æµ‹è¯•åœºæ™¯5: æ•…éšœæ’é™¤æ¨¡å¼

**æ¨¡æ‹Ÿç½‘ç»œé—®é¢˜æ—¶çš„æµ‹è¯•**:
```bash
# åœ¨ç½‘ç»œä¸ç¨³å®šæ—¶ä½¿ç”¨è·³è¿‡NTPæ¨¡å¼ç»§ç»­æµ‹è¯•
./start_test.sh sender --skip-ntp --enable-gps --time=180

# æˆ–è€…ä½¿ç”¨å¤‡ç”¨ç½‘ç»œè¿›è¡ŒNTPåŒæ­¥
./start_test.sh sender \
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=10.0.0.20 \
  --time=180
```

### æµ‹è¯•åœºæ™¯6: UDPç½‘ç»œé”™è¯¯å¤„ç†æµ‹è¯• ğŸ†•

**ç›®æ ‡**: æµ‹è¯•æ— äººæœºé£è¡Œä¸­ç½‘ç»œé—´æ­‡æ€§ä¸­æ–­çš„æ¢å¤èƒ½åŠ›

```bash
# åŸºæœ¬ç½‘ç»œé”™è¯¯å¤„ç†æµ‹è¯•
./start_test.sh sender \
  --peer-ip=192.168.104.20 \
  --time=300 \
  --network-retry-delay=2.0 \
  --log-network-errors=true

# å¿«é€Ÿé‡è¯•æ¨¡å¼ï¼ˆé€‚ç”¨äºç½‘ç»œå¿«é€Ÿæ¢å¤çš„åœºæ™¯ï¼‰
./start_test.sh sender \
  --peer-ip=192.168.104.20 \
  --time=600 \
  --network-retry-delay=0.5 \
  --frequency=5

# æ…¢é€Ÿé‡è¯•æ¨¡å¼ï¼ˆé€‚ç”¨äºç½‘ç»œä¸ç¨³å®šçš„åœºæ™¯ï¼‰
./start_test.sh sender \
  --peer-ip=192.168.104.20 \
  --time=600 \
  --network-retry-delay=5.0 \
  --frequency=2
```

**æ–°å¢start_test.shå‚æ•°è¯´æ˜** ğŸ†•:
- `--network-retry-delay=SEC`: ç½‘ç»œé”™è¯¯é‡è¯•å»¶è¿Ÿ(ç§’)ï¼Œé»˜è®¤1.0ç§’
- `--log-network-errors=BOOL`: æ˜¯å¦è®°å½•ç½‘ç»œé”™è¯¯åˆ°æ—¥å¿—ï¼Œé»˜è®¤true

**é¢„æœŸç»“æœ**:
- ç½‘ç»œä¸­æ–­æ—¶ç¨‹åºä¸ä¼šå´©æºƒé€€å‡º
- æ˜¾ç¤ºç½‘ç»œé”™è¯¯å’Œé‡è¯•ä¿¡æ¯
- ç½‘ç»œæ¢å¤åè‡ªåŠ¨ç»§ç»­å‘é€
- å®Œæ•´çš„æˆåŠŸç‡ç»Ÿè®¡ä¿¡æ¯

### éªŒè¯æ–°åŠŸèƒ½çš„æ£€æŸ¥æ¸…å•

#### âœ… æµ‹è¯•æ–°çš„æ—¶é—´é…ç½®é€»è¾‘ ğŸ†•
- [ ] ç¡®è®¤--timeå‚æ•°è¡¨ç¤ºUDPé€šä¿¡æ—¶é—´
- [ ] ç¡®è®¤æ¥æ”¶ç«¯è‡ªåŠ¨å¢åŠ ç¼“å†²æ—¶é—´
- [ ] ç¡®è®¤GPS/Nexfiè®°å½•å™¨è¿è¡Œæ—¶é—´è‡ªåŠ¨è®¡ç®—
- [ ] ç¡®è®¤ç¨‹åºæ˜¾ç¤ºè¯¦ç»†çš„æ—¶é—´åˆ†è§£ä¿¡æ¯
- [ ] ç¡®è®¤æ¥æ”¶ç«¯èƒ½å®Œæ•´æ¥æ”¶æ‰€æœ‰æ•°æ®åŒ…

#### âœ… æµ‹è¯• `--skip-ntp` å‚æ•°
- [ ] ç¡®è®¤è·³è¿‡äº†æ‰€æœ‰NTPé…ç½®æ­¥éª¤
- [ ] ç¡®è®¤ç³»ç»Ÿç›‘æ§æ—¥å¿—ä¸­ `ntp_enabled` ä¸º `false`
- [ ] ç¡®è®¤UDPæµ‹è¯•æ­£å¸¸è¿›è¡Œ
- [ ] ç¡®è®¤ä¸éœ€è¦sudoæƒé™

#### âœ… æµ‹è¯• `--ntp-peer-ip` å‚æ•°
- [ ] ç¡®è®¤NTPåŒæ­¥ä½¿ç”¨æŒ‡å®šçš„IPåœ°å€
- [ ] ç¡®è®¤UDPé€šä¿¡ä½¿ç”¨ä¸åŒçš„IPåœ°å€
- [ ] ç¡®è®¤æ—¶é—´åŒæ­¥æˆåŠŸ
- [ ] ç¡®è®¤ç½‘ç»œæµé‡åˆ†ç¦»

#### âœ… æµ‹è¯•å‘ä¸‹å…¼å®¹æ€§
- [ ] ç¡®è®¤ä¸ä½¿ç”¨æ–°å‚æ•°æ—¶è¡Œä¸ºä¸å˜
- [ ] ç¡®è®¤ç°æœ‰è„šæœ¬å’Œé…ç½®æ–‡ä»¶ä»ç„¶å·¥ä½œ
- [ ] ç¡®è®¤æ—¥å¿—æ ¼å¼å‘ä¸‹å…¼å®¹

#### âœ… æµ‹è¯•é”™è¯¯å¤„ç†
- [ ] æµ‹è¯•NTPç½‘ç»œä¸å¯è¾¾æ—¶çš„è¡Œä¸º
- [ ] æµ‹è¯•æ— æ•ˆIPåœ°å€çš„å¤„ç†
- [ ] æµ‹è¯•å‚æ•°å†²çªçš„å¤„ç†

### å¿«é€ŸåŠŸèƒ½éªŒè¯è„šæœ¬

åˆ›å»ºä¸€ä¸ªå¿«é€ŸéªŒè¯è„šæœ¬ `test_new_features.sh`:

```bash
#!/bin/bash
echo "=== æµ‹è¯•æ–°æ—¶é—´é…ç½®å’ŒNTPåŠŸèƒ½ ==="

echo "1. æµ‹è¯•æ—¶é—´é…ç½®é€»è¾‘..."
timeout 90 ./start_test.sh sender --time=30 > time_test.log 2>&1 &
SENDER_PID=$!
sleep 5
timeout 120 ./start_test.sh receiver --time=30 > receiver_time_test.log 2>&1 &
RECEIVER_PID=$!

wait $SENDER_PID $RECEIVER_PID

# æ£€æŸ¥æ—¶é—´é…ç½®
if grep -q "UDPé€šä¿¡æ—¶é—´: 30ç§’" time_test.log && grep -q "ç¼“å†²æ—¶é—´:" receiver_time_test.log; then
    echo "âœ“ æ—¶é—´é…ç½®é€»è¾‘æ­£ç¡®"
else
    echo "âœ— æ—¶é—´é…ç½®é€»è¾‘æœ‰é—®é¢˜"
fi

echo "2. æµ‹è¯•è·³è¿‡NTPåŠŸèƒ½..."
timeout 60 ./start_test.sh sender --skip-ntp --time=20 > skip_ntp_test.log 2>&1 &
wait
if grep -q "è·³è¿‡æ—¶é—´åŒæ­¥" skip_ntp_test.log; then
    echo "âœ“ è·³è¿‡NTPåŠŸèƒ½æ­£å¸¸"
else
    echo "âœ— è·³è¿‡NTPåŠŸèƒ½æœ‰é—®é¢˜"
fi

echo "3. æµ‹è¯•ç‹¬ç«‹NTP IPåŠŸèƒ½..."
timeout 90 ./start_test.sh sender --ntp-peer-ip=192.168.1.20 --time=20 > ntp_ip_test.log 2>&1 &
wait
if grep -q "NTPå¯¹æ—¶ä¸“ç”¨IP" ntp_ip_test.log || grep -q "192.168.1.20" ntp_ip_test.log; then
    echo "âœ“ ç‹¬ç«‹NTP IPåŠŸèƒ½æ­£å¸¸"
else
    echo "âœ— ç‹¬ç«‹NTP IPåŠŸèƒ½æœ‰é—®é¢˜"
fi

echo "4. æ£€æŸ¥ç³»ç»Ÿç›‘æ§æ—¥å¿—..."
if [ -f "logs/system_monitor.jsonl" ]; then
    echo "æœ€æ–°ç›‘æ§è®°å½•:"
    tail -1 logs/system_monitor.jsonl | jq '.'
    echo "âœ“ ç›‘æ§æ—¥å¿—æ ¼å¼æ­£ç¡®"
else
    echo "âš  ç›‘æ§æ—¥å¿—æ–‡ä»¶æœªæ‰¾åˆ°"
fi

echo "=== æµ‹è¯•å®Œæˆ ==="
echo "è¯¦ç»†æ—¥å¿—æ–‡ä»¶ï¼š"
ls -la *test.log
```

## æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æ—¥å¿—æ–‡ä»¶ï¼š
- ç³»ç»Ÿæ—¥å¿—: `/var/log/syslog`
- Chronyæ—¥å¿—: `/var/log/chrony/`
- æµ‹è¯•æ—¥å¿—: `./logs/`
- ROS2æ—¥å¿—: `~/.ros/log/`

å¯¹äºæ–°åŠŸèƒ½ç›¸å…³çš„é—®é¢˜ï¼š
- NTPè·³è¿‡åŠŸèƒ½: æ£€æŸ¥ `system_monitor.jsonl` ä¸­çš„ `ntp_enabled` å­—æ®µ
- ç‹¬ç«‹NTP IP: æ£€æŸ¥ç½‘ç»œè·¯ç”±å’Œè¿é€šæ€§
- å‚æ•°å…¼å®¹æ€§: æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

æˆ–è€…è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿã€‚

## æ—¶é—´é…ç½®æœ€ä½³å®è·µ ğŸ†•

### æ—¶é—´å‚æ•°è§„åˆ’æŒ‡å—

#### çŸ­æ—¶é—´æµ‹è¯• (< 2åˆ†é’Ÿ)
```bash
# é€‚ç”¨äºå¿«é€ŸéªŒè¯æˆ–è°ƒè¯•
./start_test.sh sender --time=60    # å‘é€ç«¯: ~120sæ€»æ—¶é—´
./start_test.sh receiver --time=60  # æ¥æ”¶ç«¯: ~180sæ€»æ—¶é—´
```
- ç¼“å†²æ—¶é—´: 60ç§’ (å›ºå®šæœ€å°å€¼)
- é€‚ç”¨åœºæ™¯: åŠŸèƒ½éªŒè¯ã€å‚æ•°è°ƒè¯•ã€å¿«é€Ÿæµ‹è¯•

#### ä¸­ç­‰æ—¶é—´æµ‹è¯• (2-10åˆ†é’Ÿ)
```bash
# é€‚ç”¨äºæ€§èƒ½æµ‹è¯•
./start_test.sh sender --time=300   # å‘é€ç«¯: ~360sæ€»æ—¶é—´
./start_test.sh receiver --time=300 # æ¥æ”¶ç«¯: ~420sæ€»æ—¶é—´
```
- ç¼“å†²æ—¶é—´: 60ç§’ (20% = 60s)
- é€‚ç”¨åœºæ™¯: æ€§èƒ½è¯„ä¼°ã€ç¨³å®šæ€§æµ‹è¯•ã€æ•°æ®æ”¶é›†

#### é•¿æ—¶é—´æµ‹è¯• (> 10åˆ†é’Ÿ)
```bash
# é€‚ç”¨äºå‹åŠ›æµ‹è¯•å’Œé•¿æœŸç¨³å®šæ€§éªŒè¯
./start_test.sh sender --time=1800   # å‘é€ç«¯: ~1860sæ€»æ—¶é—´
./start_test.sh receiver --time=1800 # æ¥æ”¶ç«¯: ~2220sæ€»æ—¶é—´
```
- ç¼“å†²æ—¶é—´: 360ç§’ (20% = 360s)
- é€‚ç”¨åœºæ™¯: å‹åŠ›æµ‹è¯•ã€é•¿æœŸç¨³å®šæ€§ã€ç”Ÿäº§ç¯å¢ƒéªŒè¯

### æ—¶é—´é…ç½®å¸¸è§é—®é¢˜

#### é—®é¢˜1: æ¥æ”¶ç«¯æå‰å…³é—­

**ç—‡çŠ¶**: 
```
æ¥æ”¶ç«¯æ—¥å¿—æ˜¾ç¤º: "UDP receiver completed"
å‘é€ç«¯ä»åœ¨è¿è¡Œï¼Œä½†æ¥æ”¶ç«¯å·²åœæ­¢
æ•°æ®åŒ…ä¸¢å¤±ç‡å¼‚å¸¸é«˜
```

**åŸå› **: 
- æ¥æ”¶ç«¯å’Œå‘é€ç«¯å¯åŠ¨æ—¶é—´å·®å¼‚å¤ªå¤§
- å‡†å¤‡æ—¶é—´ä¼°ç®—ä¸å‡†ç¡®
- ç½‘ç»œå»¶è¿Ÿå¯¼è‡´æ—¶é—´å·®

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ¡ˆ1: å¢åŠ UDPé€šä¿¡æ—¶é—´
./start_test.sh receiver --time=400  # è€Œä¸æ˜¯300

# æ–¹æ¡ˆ2: æ‰‹åŠ¨åŒæ­¥å¯åŠ¨
# åœ¨ä¸¤å°æ— äººæœºä¸Šå‡ ä¹åŒæ—¶æ‰§è¡Œå‘½ä»¤

# æ–¹æ¡ˆ3: ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–
./synchronized_test.sh 300  # è‡ªå®šä¹‰è„šæœ¬å¤„ç†åŒæ­¥
```

#### é—®é¢˜2: GPS/Nexfiè®°å½•æ—¶é—´ä¸å¤Ÿ

**ç—‡çŠ¶**:
```
GPSè®°å½•å™¨åœ¨UDPæµ‹è¯•å®Œæˆå‰å°±åœæ­¢äº†
NexfiçŠ¶æ€è®°å½•ç¼ºå¤±æµ‹è¯•åæœŸæ•°æ®
```

**è§£å†³æ–¹æ¡ˆ**:
ç¨‹åºå·²è‡ªåŠ¨å¤„ç†æ­¤é—®é¢˜ï¼š
- GPSè®°å½•æ—¶é—´ = UDPæ—¶é—´ + ç¼“å†²æ—¶é—´ + 120ç§’å‡†å¤‡æ—¶é—´
- Nexfiè®°å½•æ—¶é—´ = UDPæ—¶é—´ + ç¼“å†²æ—¶é—´ + 120ç§’å‡†å¤‡æ—¶é—´

#### é—®é¢˜3: å‡†å¤‡æ—¶é—´é¢„ä¼°ä¸å‡†ç¡®

**ç—‡çŠ¶**:
```
å®é™…å‡†å¤‡æ—¶é—´è¶…è¿‡é¢„æœŸ
NTPå¯¹æ—¶èŠ±è´¹æ—¶é—´è¿‡é•¿
GPSå¯åŠ¨ç¼“æ…¢
```

**ç›‘æ§å’Œè¯Šæ–­**:
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¶é—´åˆ†è§£
grep "å‡†å¤‡æ—¶é—´" logs/udp_test_*.log
grep "æ€»è¿è¡Œæ—¶é—´" logs/udp_test_*.log

# æ£€æŸ¥å„ç»„ä»¶å¯åŠ¨æ—¶é—´
grep "NTP.*æˆåŠŸ" logs/udp_test_*.log
grep "GPS.*å¯åŠ¨æˆåŠŸ" logs/udp_test_*.log
grep "Nexfi.*å¯åŠ¨æˆåŠŸ" logs/udp_test_*.log
```

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬å»ºè®®

#### åˆ›å»ºåŒæ­¥å¯åŠ¨è„šæœ¬

`synchronized_test.sh`:
```bash
#!/bin/bash
# ä½¿ç”¨æ–¹æ³•: ./synchronized_test.sh <mode> <time> [other_args]

MODE=$1
TIME=$2
shift 2

echo "=== åŒæ­¥UDPæµ‹è¯•å¯åŠ¨ ==="
echo "æ¨¡å¼: $MODE"
echo "UDPé€šä¿¡æ—¶é—´: ${TIME}ç§’"

# è®¡ç®—é¢„æœŸæ€»æ—¶é—´
if [[ "$MODE" == "sender" ]]; then
    TOTAL_TIME=$((TIME + 80))  # 80ç§’å‡†å¤‡æ—¶é—´é¢„ä¼°
else
    BUFFER_TIME=$((TIME > 300 ? TIME / 5 : 60))
    TOTAL_TIME=$((TIME + BUFFER_TIME + 80))
fi

echo "é¢„è®¡æ€»æ—¶é—´: ${TOTAL_TIME}ç§’"
echo "å¯åŠ¨å€’è®¡æ—¶..."

# 3ç§’å€’è®¡æ—¶
for i in 3 2 1; do
    echo "$i..."
    sleep 1
done

echo "å¯åŠ¨!"
./start_test.sh $MODE --time=$TIME "$@"
```

#### æ‰¹é‡æµ‹è¯•è„šæœ¬

`batch_test.sh`:
```bash
#!/bin/bash
# æ‰¹é‡æµ‹è¯•ä¸åŒæ—¶é—´é…ç½®

TEST_TIMES=(60 300 600 1200)

for time in "${TEST_TIMES[@]}"; do
    echo "=== æµ‹è¯• ${time}ç§’ UDPé€šä¿¡ ==="
    
    # åˆ›å»ºæµ‹è¯•ç›®å½•
    mkdir -p "test_results/${time}s"
    
    # è¿è¡Œæµ‹è¯•
    ./start_test.sh $1 --time=$time --log-path="test_results/${time}s" || {
        echo "æµ‹è¯•å¤±è´¥: ${time}ç§’"
        continue
    }
    
    # åˆ†æç»“æœ
    echo "æµ‹è¯•å®Œæˆ: ${time}ç§’"
    if [ -f "test_results/${time}s/udp_receiver_*.csv" ]; then
        PACKET_COUNT=$(tail -n +2 "test_results/${time}s/udp_receiver_*.csv" | wc -l)
        echo "æ¥æ”¶æ•°æ®åŒ…æ•°: $PACKET_COUNT"
    fi
    
    sleep 10  # é—´éš”æ—¶é—´
done
```

### æ€§èƒ½è°ƒä¼˜å»ºè®®

#### ç½‘ç»œç¯å¢ƒä¼˜åŒ–
- **æœ‰çº¿è¿æ¥**: ä½¿ç”¨æœ‰çº¿ç½‘ç»œå¯å‡å°‘å‡†å¤‡æ—¶é—´å’Œæé«˜ç¨³å®šæ€§
- **ç½‘ç»œå»¶è¿Ÿ**: é«˜å»¶è¿Ÿç½‘ç»œéœ€è¦å¢åŠ æ›´å¤šç¼“å†²æ—¶é—´
- **å¸¦å®½é™åˆ¶**: ä½å¸¦å®½ç¯å¢ƒå»ºè®®é™ä½å‘é€é¢‘ç‡æˆ–åŒ…å¤§å°

#### ç³»ç»Ÿèµ„æºä¼˜åŒ–
- **CPUè´Ÿè½½**: é«˜CPUä½¿ç”¨ç‡ä¼šå½±å“æ—¶é—´ç²¾åº¦ï¼Œå»ºè®®å…³é—­ä¸å¿…è¦æœåŠ¡
- **å†…å­˜ä½¿ç”¨**: ç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜é¿å…swapå½±å“æ€§èƒ½
- **ç£ç›˜I/O**: ä½¿ç”¨SSDå¯æé«˜æ—¥å¿—å†™å…¥æ€§èƒ½

#### æ—¶é—´åŒæ­¥ä¼˜åŒ–
- **æœ¬åœ°æ—¶é’Ÿ**: ä½¿ç”¨é«˜ç²¾åº¦æ—¶é’Ÿæº
- **NTPé…ç½®**: ä¼˜åŒ–chronyé…ç½®å‚æ•°
- **ç½‘ç»œè·¯å¾„**: NTPæµé‡ä½¿ç”¨ä¸“ç”¨ç½‘ç»œè·¯å¾„

## æ—¶é—´åŒæ­¥æœºåˆ¶ 

### é™æ€è·¯ç”±ç›¸å…³å‚æ•° ğŸ†•

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--enable-static-route` | flag | false | å¯ç”¨é™æ€è·¯ç”±é…ç½®åŠŸèƒ½ |

**é™æ€è·¯ç”±é…ç½®é€»è¾‘**:
- **è·¯ç”±è§„åˆ™**: è‡ªåŠ¨æ‰§è¡Œ `ip route add [local-ip]/32 via [nexfi-ip]`
- **æ™ºèƒ½æ£€æµ‹**: æ£€æŸ¥è·¯ç”±æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤é…ç½®
- **ç½‘å…³éªŒè¯**: pingæ£€æµ‹ç½‘å…³ï¼ˆnexfi-ipï¼‰çš„è¿é€šæ€§
- **æƒé™æ£€æŸ¥**: éœ€è¦sudoæƒé™æ‰§è¡Œip routeå‘½ä»¤
- **è‡ªåŠ¨æ¸…ç†**: è„šæœ¬é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†é…ç½®çš„é™æ€è·¯ç”± ğŸ†•
- **æ•…éšœå¤„ç†**: é…ç½®å¤±è´¥æ—¶æä¾›è¯¦ç»†è¯Šæ–­ä¿¡æ¯

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# åŸºæœ¬é™æ€è·¯ç”±é…ç½®
./start_test.sh sender \
  --local-ip=192.168.104.112 \
  --nexfi-ip=192.168.104.12 \
  --enable-static-route

# ç³»ç»Ÿå°†æ‰§è¡Œï¼šsudo ip route add 192.168.104.112/32 via 192.168.104.12
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ **ä¾èµ–å…³ç³»**: éœ€è¦åŒæ—¶è®¾ç½® `--local-ip` å’Œ `--nexfi-ip` å‚æ•°
- âš ï¸ **æƒé™è¦æ±‚**: éœ€è¦sudoæƒé™é…ç½®ç³»ç»Ÿè·¯ç”±è¡¨
- âš ï¸ **ç½‘ç»œè§„åˆ’**: ç¡®ä¿nexfi-ipä½œä¸ºç½‘å…³èƒ½å¤Ÿæ­£ç¡®è·¯ç”±local-ip
- âš ï¸ **è·¯ç”±å†²çª**: æ£€æŸ¥ç°æœ‰è·¯ç”±è¡¨ï¼Œé¿å…é…ç½®å†²çªçš„è·¯ç”±è§„åˆ™
- âœ… **è‡ªåŠ¨æ¸…ç†**: è„šæœ¬ä¼šåœ¨é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†é…ç½®çš„é™æ€è·¯ç”±ï¼Œä¿æŒç³»ç»Ÿæ¸…æ´ ğŸ†•

### ä½¿ç”¨åœºæ™¯è¯´æ˜

### NTPè§’è‰²åˆ†é…é€»è¾‘ ğŸ†•

**é‡è¦æ›´æ–°**: ç³»ç»Ÿå·²æ”¹ä¸ºåŸºäº sender/receiver æ¨¡å¼çš„å›ºå®šè§’è‰²åˆ†é…ï¼Œä¸å†æ ¹æ®IPåœ°å€å¤§å°æ¯”è¾ƒã€‚

#### å›ºå®šè§’è‰²åˆ†é…
- **sender å›ºå®šä½œä¸º NTP æœåŠ¡å™¨**: æ— è®ºIPåœ°å€å¤§å°ï¼Œsenderæ€»æ˜¯å¯åŠ¨NTPæœåŠ¡å™¨
- **receiver å›ºå®šä½œä¸º NTP å®¢æˆ·ç«¯**: receiveræ€»æ˜¯è¿æ¥senderçš„NTPæœåŠ¡å™¨è¿›è¡Œæ—¶é—´åŒæ­¥

```
å‘é€ç«¯ (sender)    â†â†’    æ¥æ”¶ç«¯ (receiver)
NTPæœåŠ¡å™¨                 NTPå®¢æˆ·ç«¯
åœ¨æŒ‡å®šIPä¸Šç›‘å¬             è¿æ¥åˆ°æœåŠ¡å™¨IP
```

#### `--ntp-peer-ip` å‚æ•°è¯¦è§£ ğŸ”‘

**å…³é”®ç†è§£**: `--ntp-peer-ip` åœ¨ä¸¤ç§æ¨¡å¼ä¸‹å«ä¹‰ä¸åŒï¼Œä½†æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€

| æ¨¡å¼ | `--ntp-peer-ip` å«ä¹‰ | ä½œç”¨ |
|------|---------------------|------|
| **sender** | æœ¬æœºNTPæœåŠ¡å™¨ç›‘å¬IP | senderåœ¨è¿™ä¸ªIPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨ |
| **receiver** | è¦è¿æ¥çš„NTPæœåŠ¡å™¨IP | receiverè¿æ¥åˆ°è¿™ä¸ªIPçš„NTPæœåŠ¡å™¨ |

**é…ç½®ç¤ºä¾‹**:
```bash
# ä¸¤å°æœºå™¨éƒ½å¡«å†™åŒä¸€ä¸ªIPåœ°å€ï¼š192.168.0.200
# è¿™ä¸ªIPå¿…é¡»æ˜¯senderæœºå™¨ä¸Šçš„ç½‘ç»œæ¥å£IP

# senderæœºå™¨é…ç½®
./start_test.sh sender \
  --local-ip=192.168.104.112 \
  --peer-ip=192.168.104.109 \
  --ntp-peer-ip=192.168.0.200    # senderåœ¨æ­¤IPä¸Šå¯åŠ¨NTPæœåŠ¡å™¨

# receiveræœºå™¨é…ç½®  
./start_test.sh receiver \
  --local-ip=192.168.104.109 \
  --peer-ip=192.168.104.112 \
  --ntp-peer-ip=192.168.0.200    # receiverè¿æ¥åˆ°æ­¤IPçš„NTPæœåŠ¡å™¨
```

#### ç½‘ç»œæ¥å£æ£€æŸ¥

senderä¼šè‡ªåŠ¨æ£€æŸ¥æŒ‡å®šçš„NTPæœåŠ¡å™¨IPæ˜¯å¦å­˜åœ¨äºæœ¬æœºç½‘ç»œæ¥å£ï¼š

```bash
# å¦‚æœ192.168.0.200å­˜åœ¨äºsenderçš„ç½‘ç»œæ¥å£
âœ“ å°†åœ¨æŒ‡å®šIP 192.168.0.200 ä¸Šç›‘å¬

# å¦‚æœ192.168.0.200ä¸å­˜åœ¨äºsenderçš„ç½‘ç»œæ¥å£  
âš ï¸  æŒ‡å®šIP 192.168.0.200 ä¸å­˜åœ¨ï¼Œå°†ç›‘å¬æ‰€æœ‰æ¥å£ (0.0.0.0)
```

#### å¸¸è§é…ç½®åœºæ™¯

**åœºæ™¯1: å•ç½‘å¡ç¯å¢ƒï¼ˆNTPå’ŒUDPä½¿ç”¨åŒä¸€ç½‘æ®µï¼‰**
```bash
# sender
./start_test.sh sender \
  --local-ip=192.168.104.10 \
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.104.10    # ä½¿ç”¨æœ¬æœºUDPé€šä¿¡IPä½œä¸ºNTPæœåŠ¡å™¨IP

# receiver
./start_test.sh receiver \
  --local-ip=192.168.104.20 \
  --peer-ip=192.168.104.10 \
  --ntp-peer-ip=192.168.104.10    # è¿æ¥åˆ°senderçš„UDPé€šä¿¡IP
```

**åœºæ™¯2: åŒç½‘å¡ç¯å¢ƒï¼ˆNTPå’ŒUDPä½¿ç”¨ä¸åŒç½‘æ®µï¼‰**
```bash
# senderæœºå™¨æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼š
# - eth0: 192.168.104.10 (UDPé€šä¿¡ç½‘æ®µ)  
# - eth1: 192.168.0.200 (NTPå¯¹æ—¶ä¸“ç”¨ç½‘æ®µ)

# senderé…ç½®
./start_test.sh sender \
  --local-ip=192.168.104.10 \     # UDPé€šä¿¡ä½¿ç”¨eth0
  --peer-ip=192.168.104.20 \
  --ntp-peer-ip=192.168.0.200     # NTPæœåŠ¡å™¨ä½¿ç”¨eth1

# receiveré…ç½®
./start_test.sh receiver \
  --local-ip=192.168.104.20 \     # UDPé€šä¿¡ä½¿ç”¨å¯¹åº”æ¥å£
  --peer-ip=192.168.104.10 \  
  --ntp-peer-ip=192.168.0.200     # è¿æ¥åˆ°senderçš„eth1æ¥å£
```

**åœºæ™¯3: é»˜è®¤è¡Œä¸ºï¼ˆä¸æŒ‡å®š--ntp-peer-ipï¼‰**
```bash
# å¦‚æœä¸æŒ‡å®š--ntp-peer-ipï¼Œç³»ç»Ÿä½¿ç”¨--peer-ipçš„å€¼
# sender
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20
# ç­‰ä»·äº: --ntp-peer-ip=192.168.104.20ï¼ˆä½†è¿™æ˜¯é”™è¯¯çš„ï¼ï¼‰

# æ­£ç¡®åšæ³•ï¼šæ˜ç¡®æŒ‡å®šsenderçš„IPä½œä¸ºNTPæœåŠ¡å™¨IP
./start_test.sh sender --local-ip=192.168.104.10 --peer-ip=192.168.104.20 --ntp-peer-ip=192.168.104.10
./start_test.sh receiver --local-ip=192.168.104.20 --peer-ip=192.168.104.10 --ntp-peer-ip=192.168.104.10
```

#### é…ç½®éªŒè¯

**æ£€æŸ¥senderçš„ç½‘ç»œæ¥å£**:
```bash
# åœ¨senderæœºå™¨ä¸Šæ£€æŸ¥ç½‘ç»œæ¥å£
ip addr show

# ç¡®è®¤NTPæœåŠ¡å™¨IPå­˜åœ¨
ip addr show | grep "192.168.0.200"
```

**æ£€æŸ¥NTPè¿é€šæ€§**:
```bash
# åœ¨receiveræœºå™¨ä¸Šæµ‹è¯•NTPæœåŠ¡å™¨è¿é€šæ€§
ping 192.168.0.200

# æµ‹è¯•NTPç«¯å£ï¼ˆUDP 123ï¼‰
nc -u -z -w 3 192.168.0.200 123
```

#### é‡è¦æé†’ âš ï¸

1. **IPåœ°å€è§„åˆ’**: `--ntp-peer-ip` å¿…é¡»æ˜¯senderæœºå™¨ä¸ŠçœŸå®å­˜åœ¨çš„ç½‘ç»œæ¥å£IP
2. **ç½‘ç»œè·¯ç”±**: ç¡®ä¿receiverèƒ½å¤Ÿè·¯ç”±åˆ°senderçš„NTPæœåŠ¡å™¨IP
3. **é˜²ç«å¢™**: ç¡®ä¿NTPç«¯å£ï¼ˆUDP 123ï¼‰æœªè¢«é˜»æ­¢
4. **ä¸€è‡´æ€§**: ä¸¤å°æœºå™¨çš„ `--ntp-peer-ip` å¿…é¡»å¡«å†™ç›¸åŒçš„IPåœ°å€
5. **ç½‘ç»œåˆ†ç¦»**: å¦‚æœä½¿ç”¨ç‹¬ç«‹NTPç½‘ç»œï¼Œç¡®ä¿ä¸¤å°æœºå™¨éƒ½èƒ½è®¿é—®è¯¥ç½‘ç»œ

### åŒæ­¥ç²¾åº¦
- **åˆå§‹åŒæ­¥**: Â±50msä»¥å†…ï¼ˆä»£ç ä¸­çš„é˜ˆå€¼ï¼‰
- **ç¨³å®šè¿è¡Œ**: Â±5-10ms
- **ç½‘ç»œè‰¯å¥½æ—¶**: Â±1-3ms

### ç›‘æ§æœºåˆ¶
- æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡åŒæ­¥çŠ¶æ€
- è‡ªåŠ¨è®°å½•æ—¶é—´åç§»é‡åˆ°ç³»ç»Ÿç›‘æ§æ—¥å¿—
- åŒæ­¥å¼‚å¸¸æ—¶å‘å‡ºè­¦å‘Š
- å®æ—¶æ˜¾ç¤ºåŒæ­¥çŠ¶æ€å’Œåç§»é‡

### æ•…éšœæ¢å¤æœºåˆ¶
- å®¢æˆ·ç«¯è¿æ¥å¤±è´¥æ—¶ä¼šæŒç»­é‡è¯•
- æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸ä¼šè‡ªåŠ¨é‡å¯æœåŠ¡
- ç½‘ç»œä¸­æ–­åè‡ªåŠ¨æ¢å¤åŒæ­¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. GPSè®°å½•å™¨å¯åŠ¨å¤±è´¥
**ç—‡çŠ¶**: æ˜¾ç¤º "GPS logger failed to start"
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ROS2ç¯å¢ƒ
source /opt/ros/humble/setup.bash

# æ£€æŸ¥æ— äººæœºè¿æ¥
ros2 topic list | grep drone

# æ£€æŸ¥GPSæ¥å£
python3 -c "from as2_python_api.drone_interface_gps import DroneInterfaceGPS"

# æ‰‹åŠ¨æµ‹è¯•GPSè®°å½•å™¨
python3 gps.py --drone-id=drone0 --time=10
```

#### 2. GPSæ•°æ®å…¨ä¸º0
**ç—‡çŠ¶**: GPSåæ ‡æ˜¾ç¤ºä¸º (0.0, 0.0, 0.0)
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥GPSè¯é¢˜
```

#### 4. å¯¹æ–¹æ— äººæœºä¸å¯è¾¾
**ç—‡çŠ¶**: ping å¯¹æ–¹IPå¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œé…ç½®
ip addr show
ip route show

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 192.168.104.20

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw allow from 192.168.104.0/24
```

#### 5. é™æ€è·¯ç”±é…ç½®å¤±è´¥ ğŸ†•
**ç—‡çŠ¶**: 
- æ˜¾ç¤º "é™æ€è·¯ç”±é…ç½®å¤±è´¥"
- æç¤ºæƒé™ä¸è¶³æˆ–ç½‘å…³ä¸å¯è¾¾
- è·¯ç”±è¡¨æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ­¥éª¤1: æ£€æŸ¥sudoæƒé™
sudo -v
echo "å¦‚æœæç¤ºè¾“å…¥å¯†ç ï¼Œè¯´æ˜éœ€è¦sudoæƒé™"

# æ­¥éª¤2: éªŒè¯ç½‘å…³è¿é€šæ€§
ping -c 3 192.168.104.12  # æ›¿æ¢ä¸ºæ‚¨çš„nexfi-ip

# æ­¥éª¤3: æ£€æŸ¥ç°æœ‰è·¯ç”±è¡¨
ip route show
echo "æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å†²çªçš„è·¯ç”±è§„åˆ™"

# æ­¥éª¤4: æ‰‹åŠ¨æµ‹è¯•è·¯ç”±é…ç½®
sudo ip route add 192.168.104.112/32 via 192.168.104.12  # æ›¿æ¢ä¸ºå®é™…IP
ip route show 192.168.104.112/32

# æ­¥éª¤5: åˆ é™¤æµ‹è¯•è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo ip route del 192.168.104.112/32 via 192.168.104.12

# æ­¥éª¤6: æ£€æŸ¥ç½‘ç»œæ¥å£é…ç½®
ip addr show
echo "ç¡®è®¤local-ipå’Œnexfi-ipéƒ½åœ¨æ­£ç¡®çš„ç½‘æ®µ"
```

**å¸¸è§é—®é¢˜è¯Šæ–­**:
```bash
# é—®é¢˜1: æƒé™ä¸è¶³
sudo whoami  # åº”è¯¥è¿”å›root

# é—®é¢˜2: ç½‘å…³ä¸åœ¨åŒä¸€ç½‘æ®µ
echo "æ£€æŸ¥local-ipå’Œnexfi-ipæ˜¯å¦åœ¨åˆç†çš„ç½‘ç»œæ‹“æ‰‘ä¸­"
ip route get 192.168.104.12  # æŸ¥çœ‹åˆ°ç½‘å…³çš„è·¯ç”±

# é—®é¢˜3: è·¯ç”±å†²çª
ip route show | grep "192.168.104.112"  # æ£€æŸ¥ç°æœ‰è·¯ç”±

# é—®é¢˜4: ç½‘ç»œæ¥å£æœªé…ç½®
ip addr show | grep "192.168.104"  # æ£€æŸ¥IPé…ç½®
```

**ç½‘ç»œè§„åˆ’éªŒè¯**:
```bash
# éªŒè¯IPåœ°å€è§„åˆ’çš„åˆç†æ€§
echo "=== ç½‘ç»œé…ç½®æ£€æŸ¥ ==="
echo "æœ¬åœ°IP: 192.168.104.112"
echo "ç½‘å…³IP: 192.168.104.12"
echo "æ£€æŸ¥: ç½‘å…³åº”è¯¥èƒ½å¤Ÿè·¯ç”±åˆ°æœ¬åœ°IPçš„ç½‘æ®µ"

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
traceroute 192.168.104.12
echo "ç¡®ä¿ç½‘å…³åœ¨ç½‘ç»œæ‹“æ‰‘ä¸­å¯è¾¾"
```